---
import { getEntry, render } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import { getTranslatedPost, getBlogPostUrl } from '@/lib/i18n';

// Get the slug from the URL params
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

// Fetch the Spanish blog post entry
const entry = await getEntry('blog', `es/${slug}`);

if (!entry || entry.data.locale !== 'es') {
  return Astro.redirect('/404');
}

const { Content } = await render(entry);
const post = entry;

// Check if English translation exists and get its URL
const translatedPost = await getTranslatedPost(post, 'en');
const alternateUrl = translatedPost ? getBlogPostUrl(translatedPost) : undefined;

// Format date
const formattedDate = post.data.pubDate.toLocaleDateString('es-ES', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<Layout title={post.data.title} description={post.data.description} alternateUrl={alternateUrl}>
  <article style="max-width: 70ch; margin: 0 auto;">
    <header style="margin-bottom: 3rem;">
      <nav style="margin-bottom: 1.5rem;">
        <a href="/es/blog" style="text-decoration: none; color: var(--pico-muted-color); font-weight: 500; font-size: 0.9375rem;">
          ← Volver al blog
        </a>
      </nav>

      <h1 style="font-size: clamp(2rem, 4vw, 2.5rem); font-weight: 800; letter-spacing: -0.05em; line-height: 1.2; margin-bottom: 1rem;">
        {post.data.title}
      </h1>

      <div style="display: flex; gap: 1.5rem; align-items: center; color: var(--pico-muted-color); font-size: 0.9375rem;">
        <time datetime={post.data.pubDate.toISOString()}>
          {formattedDate}
        </time>
        {post.data.tags && post.data.tags.length > 0 && (
          <span class="blog-tag">{post.data.tags[0]}</span>
        )}
      </div>

      {post.data.description && (
        <p style="margin-top: 1.5rem; font-size: 1.125rem; color: var(--pico-muted-color); line-height: 1.6;">
          {post.data.description}
        </p>
      )}
    </header>

    <div class="prose">
      <Content />
    </div>
  </article>

  <div style="max-width: 70ch; margin: 3rem auto 0;">
    <hr style="margin: 3rem 0;">
    <nav>
      <a href="/es/blog" role="button" class="secondary">
        ← Volver al blog
      </a>
    </nav>
  </div>
</Layout>
