---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { getLocaleFromUrl, useTranslations } from '@/lib/i18n';
import { getTranslatedPost, getBlogPostUrl } from '@/lib/i18n-server';
import { getReadingTime } from '@/lib/reading-time';

const locale = getLocaleFromUrl(Astro.url);
const { t, formatDate } = useTranslations(locale);

// Get the slug from the URL params
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

// Find the blog post by slug field for the current locale
const allPosts = await getCollection('blog');
const entry = allPosts.find((post) => post.data.slug === slug && post.data.locale === locale);

if (!entry) {
  return Astro.redirect('/404');
}

const { Content } = await render(entry);
const post = entry;

// Check if translation exists for the alternate locale and get its URL
const alternateLocale = locale === 'es' ? 'en' : 'es';
const translatedPost = await getTranslatedPost(post, alternateLocale);
const alternateUrl = translatedPost ? getBlogPostUrl(translatedPost) : undefined;

// Format date
const formattedDate = formatDate(post.data.pubDate, {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Calculate reading time
const readingTimeMinutes = getReadingTime(entry.body ?? '');

// Structured data for SEO
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title,
  description: post.data.description,
  datePublished: post.data.pubDate.toISOString(),
  dateModified: post.data.updatedDate?.toISOString() || post.data.pubDate.toISOString(),
  author: {
    '@type': 'Person',
    name: 'Christian Rodriguez',
    url: 'https://chrisrodz.io',
  },
  publisher: {
    '@type': 'Person',
    name: 'Christian Rodriguez',
    url: 'https://chrisrodz.io',
  },
  inLanguage: locale,
  url: new URL(getBlogPostUrl(post), Astro.site || 'https://chrisrodz.io').toString(),
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': new URL(getBlogPostUrl(post), Astro.site || 'https://chrisrodz.io').toString(),
  },
  keywords: post.data.category,
};
---

<Layout title={post.data.title} description={post.data.description} alternateUrl={alternateUrl}>
  <!-- Reading Progress Bar -->
  <div class="reading-progress" id="reading-progress" style="transform: scaleX(0);"></div>

  <!-- Structured Data -->
  <script type="application/ld+json" is:inline set:html={JSON.stringify(structuredData)} />
  <article style="max-width: 70ch; margin: 0 auto;">
    <header style="margin-bottom: 3rem;">
      <nav style="margin-bottom: 1.5rem;">
        <a
          href={locale === 'en' ? '/en' : '/'}
          style="text-decoration: none; color: var(--pico-muted-color); font-weight: 500; font-size: 0.9375rem;"
        >
          ← {t('blog.backToHome')}
        </a>
      </nav>

      <h1
        style="font-size: clamp(2rem, 4vw, 2.5rem); font-weight: 800; letter-spacing: -0.05em; line-height: 1.2; margin-bottom: 1rem;"
      >
        {post.data.title}
      </h1>

      <div
        style="display: flex; gap: 1.5rem; align-items: center; color: var(--pico-muted-color); font-size: 0.9375rem;"
      >
        <time datetime={post.data.pubDate.toISOString()}>
          {formattedDate}
        </time>
        <span>{t('blog.readingTime', { minutes: readingTimeMinutes.toString() })}</span>
      </div>

      {
        post.data.description && (
          <p style="margin-top: 1.5rem; font-size: 1.125rem; color: var(--pico-muted-color); line-height: 1.6;">
            {post.data.description}
          </p>
        )
      }
    </header>

    {
      locale === 'en' && alternateUrl && (
        <aside class="notice-box" data-variant="info" role="note">
          <p>
            <small>
              {`${t('blog.aiDisclaimer.prefix')} `}
              <a href={alternateUrl} hreflang="es">
                {t('blog.aiDisclaimer.linkText')}
              </a>
              {` ${t('blog.aiDisclaimer.suffix')}`}
            </small>
          </p>
        </aside>
      )
    }

    <div class="prose">
      <Content />
    </div>
  </article>

  <div style="max-width: 70ch; margin: 3rem auto 0;">
    <hr style="margin: 3rem 0;" />
    <nav>
      <a href={locale === 'en' ? '/en' : '/'} role="button" class="secondary">
        ← {t('blog.backToHome')}
      </a>
    </nav>
  </div>

  <script>
    const progressBar = document.getElementById('reading-progress');
    if (progressBar) {
      const updateProgress = () => {
        const scrollTop = window.scrollY;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const progress = docHeight > 0 ? Math.min(scrollTop / docHeight, 1) : 0;
        progressBar.style.transform = `scaleX(${progress})`;
      };

      window.addEventListener('scroll', updateProgress, { passive: true });
      updateProgress();
    }
  </script>
</Layout>
