---
import Layout from '../../layouts/Layout.astro';
import { checkAuth, verifyAdminSecret, createSession, setAuthCookie } from '../../lib/auth';

export const prerender = false;

const cookies = Astro.cookies;
const isAuthed = checkAuth(cookies);
let loginError = '';

// Handle login form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const password = formData.get('password') as string;

  if (verifyAdminSecret(password)) {
    const sessionId = createSession();
    setAuthCookie(cookies, sessionId);
    return Astro.redirect('/admin/cafe');
  } else {
    loginError = 'Invalid password';
  }
}
---

<Layout title="Admin Dashboard" isAdmin={isAuthed}>
  {
    !isAuthed ? (
      <section>
        <h1>Admin Login</h1>
        {loginError && (
          <div style="padding: 1rem; margin: 1rem 0; background: #fee; border-radius: 4px; color: #c00;">
            {loginError}
          </div>
        )}
        <form method="POST">
          <fieldset>
            <label for="password">Admin Password</label>
            <input
              type="password"
              name="password"
              id="password"
              placeholder="Enter admin password"
              required
            />
            <button type="submit">Login</button>
          </fieldset>
        </form>
      </section>
    ) : (
      <section>
        <header class="mb">
          <h1>ğŸ—ºï¸ Site Map</h1>
          <p style="color: var(--pico-muted-color);">
            Complete directory of all pages and admin tools
          </p>
        </header>

        <div class="grid-2 mb">
          {/* Public Pages - Spanish (Default) */}
          <article>
            <h3>ğŸ“„ PÃ¡ginas PÃºblicas (EspaÃ±ol)</h3>
            <ul style="list-style: none; padding: 0;">
              <li>
                <a href="/">ğŸ  Inicio</a>
              </li>
              <li>
                <a href="/blog">ğŸ“ Blog</a>
              </li>
              <li>
                <a href="/cafe">â˜• Registro de CafÃ©</a>
              </li>
              <li>
                <a href="/training">ğŸƒ Registro de Entrenamiento</a>
              </li>
              <li>
                <a href="/rss.xml">ğŸ“¡ RSS Feed (EspaÃ±ol)</a>
              </li>
            </ul>
          </article>

          {/* Public Pages - English */}
          <article>
            <h3>ğŸ“„ Public Pages (English)</h3>
            <ul style="list-style: none; padding: 0;">
              <li>
                <a href="/en">ğŸ  Home</a>
              </li>
              <li>
                <a href="/en/blog">ğŸ“ Blog</a>
              </li>
              <li>
                <a href="/en/cafe">â˜• Coffee Tracker</a>
              </li>
              <li>
                <a href="/en/training">ğŸƒ Training Log</a>
              </li>
              <li>
                <a href="/en/rss.xml">ğŸ“¡ RSS Feed (English)</a>
              </li>
            </ul>
          </article>

          {/* Admin Pages */}
          <article>
            <h3>ğŸ”§ Admin Tools</h3>
            <ul style="list-style: none; padding: 0;">
              <li>
                <a href="/admin">ğŸ—ºï¸ Site Map (this page)</a>
              </li>
              <li>
                <a href="/admin/cafe">â˜• Coffee Logger</a>
              </li>
              <li>
                <a href="/admin/logout">ğŸšª Logout</a>
              </li>
            </ul>
          </article>

          {/* External Resources */}
          <article>
            <h3>ğŸ”— External Links</h3>
            <ul style="list-style: none; padding: 0;">
              <li>
                <a href="https://github.com/chrisrodz" target="_blank" rel="noopener noreferrer">
                  ğŸ™ GitHub Profile
                </a>
              </li>
              <li>
                <a href="mailto:hey@chrisrodz.io">ğŸ“§ Email</a>
              </li>
              <li>
                <a href="https://supabase.com/dashboard" target="_blank" rel="noopener noreferrer">
                  ğŸ—„ï¸ Supabase Dashboard
                </a>
              </li>
              <li>
                <a href="https://vercel.com/dashboard" target="_blank" rel="noopener noreferrer">
                  â–² Vercel Dashboard
                </a>
              </li>
            </ul>
          </article>
        </div>

        <details class="mb">
          <summary>ğŸ’¡ Quick Tips</summary>
          <div>
            <ul>
              <li>
                <strong>Coffee emoji (â˜•) in footer:</strong> Quick access to coffee logger when
                logged in
              </li>
              <li>
                <strong>RSS feeds:</strong> Available in both English and Spanish
              </li>
              <li>
                <strong>Database:</strong> Check Supabase dashboard for data management
              </li>
              <li>
                <strong>Deployment:</strong> Pushes to main branch auto-deploy via Vercel
              </li>
            </ul>
          </div>
        </details>

        <details>
          <summary>ğŸ› ï¸ Database Setup Instructions</summary>
          <div>
            <h4>Supabase Configuration</h4>
            <p>To get started with the coffee and training tracking features:</p>
            <ol>
              <li>
                Create a Supabase project at{' '}
                <a href="https://supabase.com" target="_blank">
                  supabase.com
                </a>
              </li>
              <li>Copy your project URL and anon key to your environment variables</li>
              <li>
                Run the SQL schema in <code>schema.sql</code> to create the required tables
              </li>
              <li>Update your environment variables and restart the application</li>
            </ol>

            <h4>Strava Integration</h4>
            <p>To sync training activities from Strava:</p>
            <ol>
              <li>
                Create a Strava application at{' '}
                <a href="https://developers.strava.com" target="_blank">
                  developers.strava.com
                </a>
              </li>
              <li>Set up OAuth and get your client credentials</li>
              <li>Add your Strava credentials to environment variables</li>
              <li>Implement the OAuth flow (coming soon)</li>
            </ol>
          </div>
        </details>
      </section>
    )
  }
</Layout>
