---
import Layout from '../layouts/Layout.astro';
import Greeting from '@/components/home/Greeting.astro';
import IntroParagraphs from '@/components/home/IntroParagraphs.astro';
import BlogPostsList from '@/components/home/BlogPostsList.astro';
import SubscribeForm from '@/components/SubscribeForm.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { getLocaleFromUrl, useTranslations } from '@/lib/i18n';

const locale = getLocaleFromUrl(Astro.url);
const { t } = useTranslations(locale);

// Fetch blog posts for current locale
let allPosts: CollectionEntry<'blog'>[] = [];
try {
  const posts = await getCollection('blog', ({ data }) => data.locale === locale);
  allPosts = posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
} catch (e) {
  console.warn('No blog posts found:', e);
}

// Structured data for SEO
const personSchema = {
  '@context': 'https://schema.org',
  '@type': 'Person',
  name: 'Christian Rodriguez',
  url: 'https://chrisrodz.io',
  email: 'hey@chrisrodz.io',
  jobTitle: 'Software Engineer',
  description: t('home.intro.paragraph1'),
  sameAs: ['https://github.com/chrisrodz', 'https://x.com/chrisrodz35'],
  knowsAbout: ['Software Engineering', 'Triathlon', 'Coffee'],
};
---

<Layout title={t('home.title')}>
  <!-- Structured Data -->
  <script type="application/ld+json" is:inline set:html={JSON.stringify(personSchema)} />
  <section style="margin-top: 3rem; margin-bottom: 4rem;">
    <Greeting locale={locale} />
    <IntroParagraphs locale={locale} />
  </section>

  <BlogPostsList posts={allPosts} locale={locale} />

  <SubscribeForm variant="full" />
</Layout>
