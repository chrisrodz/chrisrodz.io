---
import ContributionInsights from './ContributionInsights';
import GitHubContributionsChart from './GitHubContributionsChart';
import StatsCard from './StatsCard';
import type { ContributionInsights as InsightData, DayName } from '@/lib/github-api';
import { useTranslations, type Locale } from '@/lib/i18n';
import type { TranslationKey } from '@/lib/i18n-keys';
import type { Activity } from 'react-activity-calendar';

interface Props {
  locale: Locale;
}

interface Metrics {
  currentStreak: number;
  longestStreak: number;
  mostActiveDay: DayName;
}

interface StatsData {
  activities: Activity[];
  totalContributions: number;
  metrics: Metrics;
  insights: InsightData;
}

const { locale } = Astro.props;
const { t, formatNumber, formatDate } = useTranslations(locale);

let data: StatsData | null = null;
let error: string | null = null;
let latestActivityDate: Date | null = null;
let mostActiveDayKey: TranslationKey | null = null;

try {
  const response = await fetch(new URL('/api/github-contributions', Astro.url.origin).href);

  if (!response.ok) {
    const contentType = response.headers.get('content-type');
    if (contentType?.includes('application/json')) {
      try {
        const errorData = await response.json();
        error = errorData.error || t('stats.errors.failed');
      } catch {
        error = `${t('stats.errors.failed')} (${response.status} ${response.statusText})`;
      }
    } else {
      error = `${t('stats.errors.failed')} (${response.status} ${response.statusText})`;
    }
  } else {
    const result = await response.json();
    data = result.data as StatsData;
    if (data.activities.length > 0) {
      const lastActivity = data.activities[data.activities.length - 1];
      latestActivityDate = new Date(lastActivity.date);
    }
    mostActiveDayKey = `stats.metrics.dayNames.${data.metrics.mostActiveDay}` as TranslationKey;
  }
} catch (err) {
  error = t('stats.errors.failed');
  console.error('Failed to fetch GitHub contributions:', err);
}

const months = [
  t('stats.months.jan'),
  t('stats.months.feb'),
  t('stats.months.mar'),
  t('stats.months.apr'),
  t('stats.months.may'),
  t('stats.months.jun'),
  t('stats.months.jul'),
  t('stats.months.aug'),
  t('stats.months.sep'),
  t('stats.months.oct'),
  t('stats.months.nov'),
  t('stats.months.dec'),
];

const weekdays = [
  t('stats.weekdays.sun'),
  t('stats.weekdays.mon'),
  t('stats.weekdays.tue'),
  t('stats.weekdays.wed'),
  t('stats.weekdays.thu'),
  t('stats.weekdays.fri'),
  t('stats.weekdays.sat'),
];

const currentYear = new Date().getFullYear();
const activityReferenceDate = latestActivityDate ?? new Date();
---

<section aria-live="polite">
  {
    error ? (
      <article role="alert">
        <header>
          <h2>{t('common.error')}</h2>
        </header>
        <p>{error}</p>
      </article>
    ) : data ? (
      <>
        <section aria-labelledby="github-metrics-heading">
          <header>
            <h2 id="github-metrics-heading">{t('stats.metrics.heading')}</h2>
            <p>
              <strong>{formatNumber(data.totalContributions)}</strong>{' '}
              {t('stats.totalContributions', { year: currentYear.toString() })}
            </p>
          </header>
          <div class="grid">
            <StatsCard
              title={t('stats.metrics.currentStreak')}
              value={t('stats.metrics.days', {
                count: formatNumber(data.metrics.currentStreak),
              })}
              description={t('stats.metrics.currentStreakDescription', {
                date: formatDate(activityReferenceDate, {
                  month: 'long',
                  day: 'numeric',
                }),
              })}
            />
            <StatsCard
              title={t('stats.metrics.longestStreak')}
              value={t('stats.metrics.days', {
                count: formatNumber(data.metrics.longestStreak),
              })}
            />
            <StatsCard
              title={t('stats.metrics.mostActiveDay')}
              value={mostActiveDayKey ? t(mostActiveDayKey) : ''}
            />
          </div>
        </section>

        <section aria-labelledby="github-activity-heading">
          <header>
            <h2 id="github-activity-heading">{t('stats.activity.heading')}</h2>
            <p class="muted">{t('stats.activity.subtitle')}</p>
          </header>
          <GitHubContributionsChart
            client:only="react"
            data={data.activities}
            months={months}
            weekdays={weekdays}
            tooltipTemplate={t('stats.contributionTooltip')}
            legendLess={t('stats.legend.less')}
            legendMore={t('stats.legend.more')}
          />
        </section>

        <ContributionInsights
          insights={data.insights}
          t={t}
          locale={locale}
          formatDate={formatDate}
          formatNumber={formatNumber}
        />
      </>
    ) : (
      <p aria-busy="true">{t('common.loading')}</p>
    )
  }
</section>
