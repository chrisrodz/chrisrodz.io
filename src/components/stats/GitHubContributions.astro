---
import { useTranslations, type Locale } from '@/lib/i18n';
import type { Activity } from 'react-activity-calendar';
import GitHubContributionsChart from './GitHubContributionsChart';
import StatsCard from './StatsCard';

interface Props {
  locale: Locale;
}

const { locale } = Astro.props;
const { t } = useTranslations(locale);

// Server-side data fetching
let data: {
  activities: Activity[];
  totalContributions: number;
  currentStreak: number;
  longestStreak: number;
} | null = null;
let error: string | null = null;

try {
  const response = await fetch(new URL('/api/github-contributions', Astro.url.origin).href);

  if (!response.ok) {
    // Check if response is JSON before trying to parse
    const contentType = response.headers.get('content-type');
    if (contentType?.includes('application/json')) {
      try {
        const errorData = await response.json();
        error = errorData.error || t('stats.errors.failed');
      } catch {
        // JSON parsing failed
        error = `${t('stats.errors.failed')} (${response.status} ${response.statusText})`;
      }
    } else {
      // Non-JSON response (likely HTML error page)
      error = `${t('stats.errors.failed')} (${response.status} ${response.statusText})`;
    }
  } else {
    const result = await response.json();
    data = result.data;
  }
} catch (err) {
  error = t('stats.errors.failed');
  console.error('Failed to fetch GitHub contributions:', err);
}

// Prepare month and weekday labels
const months = [
  t('stats.months.jan'),
  t('stats.months.feb'),
  t('stats.months.mar'),
  t('stats.months.apr'),
  t('stats.months.may'),
  t('stats.months.jun'),
  t('stats.months.jul'),
  t('stats.months.aug'),
  t('stats.months.sep'),
  t('stats.months.oct'),
  t('stats.months.nov'),
  t('stats.months.dec'),
];

const weekdays = [
  t('stats.weekdays.sun'),
  t('stats.weekdays.mon'),
  t('stats.weekdays.tue'),
  t('stats.weekdays.wed'),
  t('stats.weekdays.thu'),
  t('stats.weekdays.fri'),
  t('stats.weekdays.sat'),
];

const currentYear = new Date().getFullYear();
---

<div class="github-contributions">
  {
    error ? (
      <div role="alert" class="error-container">
        <p>
          <strong>{t('common.error')}:</strong> {error}
        </p>
      </div>
    ) : data ? (
      <section aria-labelledby="github-stats-heading">
        <hgroup class="contributions-summary">
          <h2 id="github-stats-heading">{t('stats.githubTitle')}</h2>
          <p>{t('stats.aria.githubDescription')}</p>
        </hgroup>

        <div class="calendar-container" role="region" aria-label={t('stats.aria.calendarRegion')}>
          <GitHubContributionsChart
            client:only="react"
            data={data.activities}
            totalContributions={data.totalContributions}
            year={currentYear}
            months={months}
            weekdays={weekdays}
            tooltipTemplate={t('stats.contributionTooltip', {
              count: data.totalContributions.toString(),
              year: currentYear.toString(),
            })}
            legendLess={t('stats.legend.less')}
            legendMore={t('stats.legend.more')}
            ariaLabel={t('stats.aria.calendarChart', {
              count: data.totalContributions.toString(),
              year: currentYear.toString(),
              currentStreak: data.currentStreak.toString(),
            })}
          />
        </div>

        <div class="metrics-grid grid" aria-labelledby="metrics-heading">
          <h3 id="metrics-heading" class="visually-hidden">
            {t('stats.aria.metricsHeading')}
          </h3>
          <StatsCard
            client:only="react"
            label={t('stats.metrics.currentStreak')}
            value={`${data.currentStreak} ${t('stats.metrics.days')}`}
          />
          <StatsCard
            client:only="react"
            label={t('stats.metrics.longestStreak')}
            value={`${data.longestStreak} ${t('stats.metrics.days')}`}
          />
        </div>
      </section>
    ) : (
      <div class="loading-container" aria-live="polite" aria-busy="true">
        <p>{t('common.loading')}</p>
      </div>
    )
  }
</div>

<style>
  .github-contributions {
    width: 100%;
  }

  .metrics-grid {
    margin-bottom: 2rem;
  }

  .error-container,
  .loading-container {
    text-align: center;
    padding: 2rem 0;
  }

  .contributions-summary {
    margin-bottom: 1rem;
    text-align: center;
  }

  .calendar-container {
    display: flex;
    justify-content: center;
    overflow-x: auto;
    padding: 0 1rem;
  }

  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    margin: -1px;
    padding: 0;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
  }

  /* Ensure proper scrolling on smaller screens */
  @media (max-width: 768px) {
    .calendar-container {
      justify-content: flex-start;
    }
  }
</style>
