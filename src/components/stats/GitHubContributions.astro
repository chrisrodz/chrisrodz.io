---
import { useTranslations, type Locale } from '@/lib/i18n';
import type { Activity } from 'react-activity-calendar';
import GitHubContributionsChart from './GitHubContributionsChart';
import StatsCard from './StatsCard';
import ContributionInsights from './ContributionInsights';
import type { ContributionMetrics, InsightData, DayKey } from '@/lib/github-api';

interface Props {
  locale: Locale;
}

interface StatsResponse {
  activities: Activity[];
  totalContributions: number;
  metrics: ContributionMetrics;
  insights: InsightData;
}

const { locale } = Astro.props;
const { t } = useTranslations(locale);

let data: StatsResponse | null = null;
let error: string | null = null;

try {
  const response = await fetch(new URL('/api/github-contributions', Astro.url.origin).href);

  if (!response.ok) {
    const contentType = response.headers.get('content-type');
    if (contentType?.includes('application/json')) {
      try {
        const errorData = await response.json();
        error = errorData.error || t('stats.errors.failed');
      } catch {
        error = `${t('stats.errors.failed')} (${response.status} ${response.statusText})`;
      }
    } else {
      error = `${t('stats.errors.failed')} (${response.status} ${response.statusText})`;
    }
  } else {
    const result = (await response.json()) as { data: StatsResponse };
    data = result.data;
  }
} catch (err) {
  error = t('stats.errors.failed');
  console.error('Failed to fetch GitHub contributions:', err);
}

const months = [
  t('stats.months.jan'),
  t('stats.months.feb'),
  t('stats.months.mar'),
  t('stats.months.apr'),
  t('stats.months.may'),
  t('stats.months.jun'),
  t('stats.months.jul'),
  t('stats.months.aug'),
  t('stats.months.sep'),
  t('stats.months.oct'),
  t('stats.months.nov'),
  t('stats.months.dec'),
];

const weekdays = [
  t('stats.weekdays.sun'),
  t('stats.weekdays.mon'),
  t('stats.weekdays.tue'),
  t('stats.weekdays.wed'),
  t('stats.weekdays.thu'),
  t('stats.weekdays.fri'),
  t('stats.weekdays.sat'),
];

const currentYear = new Date().getFullYear();

const dayNames: Record<DayKey, string> = {
  sun: t('stats.metrics.dayNames.sun'),
  mon: t('stats.metrics.dayNames.mon'),
  tue: t('stats.metrics.dayNames.tue'),
  wed: t('stats.metrics.dayNames.wed'),
  thu: t('stats.metrics.dayNames.thu'),
  fri: t('stats.metrics.dayNames.fri'),
  sat: t('stats.metrics.dayNames.sat'),
};

const formatDayCount = (value: number) =>
  value === 1
    ? t('stats.metrics.singleDay', { count: value })
    : t('stats.metrics.days', { count: value });

const numberFormatter = new Intl.NumberFormat(locale);
const averageFormatter = new Intl.NumberFormat(locale, {
  minimumFractionDigits: 1,
  maximumFractionDigits: 1,
});
const dateFormatter = new Intl.DateTimeFormat(locale, { month: 'short', day: 'numeric' });

const formatDateRange = (start: string, end: string) => {
  const startText = dateFormatter.format(new Date(`${start}T00:00:00Z`));
  const endText = dateFormatter.format(new Date(`${end}T00:00:00Z`));
  return startText === endText ? startText : `${startText} â€“ ${endText}`;
};

const metricsCards = data?.metrics
  ? [
      {
        id: 'current-streak',
        title: t('stats.metrics.currentStreak'),
        value: formatDayCount(data.metrics.currentStreak),
      },
      {
        id: 'longest-streak',
        title: t('stats.metrics.longestStreak'),
        value: formatDayCount(data.metrics.longestStreak),
      },
      {
        id: 'most-active-day',
        title: t('stats.metrics.mostActiveDay'),
        value: dayNames[data.metrics.mostActiveDay] ?? dayNames.sun,
      },
    ]
  : [];

const insightsItems = data?.insights
  ? [
      {
        id: 'weekly-pattern',
        text: t('stats.insights.weeklyPattern', {
          day: dayNames[data.insights.weeklyPattern.day] ?? dayNames.sun,
          avg: averageFormatter.format(data.insights.weeklyPattern.avg),
        }),
      },
      {
        id: 'best-week',
        text: t('stats.insights.bestWeek', {
          date: formatDateRange(data.insights.bestWeek.startDate, data.insights.bestWeek.endDate),
          total: numberFormatter.format(data.insights.bestWeek.total),
        }),
      },
      {
        id: 'recent-activity',
        text: t('stats.insights.recentActivity', {
          days: numberFormatter.format(data.insights.recentActivity.days),
          percentage: numberFormatter.format(data.insights.recentActivity.percentage),
        }),
      },
    ]
  : [];
---
<div aria-live="polite">
  {
    error ? (
      <article role="alert">
        <header>
          <strong>{t('common.error')}</strong>
        </header>
        <p>{error}</p>
      </article>
    ) : data ? (
      <>
        <p>
          <strong>
            {numberFormatter.format(data.totalContributions)}{' '}
            {t('stats.totalContributions', { year: currentYear.toString() })}
          </strong>
        </p>

        <section aria-labelledby="github-metrics">
          <h2 id="github-metrics">{t('stats.metrics.heading')}</h2>
          <div class="grid">
            {metricsCards.map((card) => (
              <StatsCard title={card.title} value={card.value} key={card.id} />
            ))}
          </div>
        </section>

        <section aria-labelledby="github-activity">
          <h2 id="github-activity">{t('stats.activity.heading')}</h2>
          <GitHubContributionsChart
            client:only="react"
            data={data.activities}
            totalContributions={data.totalContributions}
            year={currentYear}
            months={months}
            weekdays={weekdays}
            tooltipTemplate={t('stats.contributionTooltip')}
            legendLess={t('stats.legend.less')}
            legendMore={t('stats.legend.more')}
          />
        </section>

        <ContributionInsights heading={t('stats.insights.heading')} items={insightsItems} />
      </>
    ) : (
      <p aria-busy="true">{t('common.loading')}</p>
    )
  }
</div>
