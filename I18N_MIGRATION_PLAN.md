# i18n Migration Plan: Spanish Default + Enhanced Translation System

## Overview

This document outlines the complete implementation plan to:

1. Switch the site default language from English to Spanish
2. Integrate Astro's built-in i18n for routing
3. Enhance the custom translation system with type safety and validation
4. Consolidate duplicate pages into single files with locale detection
5. Extract all hardcoded text to JSON translation files

**Target:** Create a feature branch with all changes implemented and tested.

**Success Criteria:**

- Spanish is the default language (no prefix: `/`)
- English uses `/en/` prefix
- All hardcoded text extracted to JSON files
- Type-safe translation keys with autocomplete
- Validation script ensures translation completeness
- All tests pass and site works correctly

---

## Phase 0: Setup & Preparation

### Task 0.1: Create Feature Branch

**Action:**

```bash
git checkout main
git pull
git checkout -b feature/spanish-default-i18n
```

**Verification:** Confirm you're on the new branch with `git branch --show-current`

---

## Phase 1: Add Type Safety & Validation Scripts

### Task 1.1: Create Translation Key Type Generator

**File:** `scripts/generate-i18n-types.js`

**Action:** Create a script that reads `en.json` and generates TypeScript types for all translation keys.

**Code:**

```javascript
#!/usr/bin/env node
import { readFileSync, writeFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const enPath = join(__dirname, '../src/i18n/en.json');
const outputPath = join(__dirname, '../src/lib/i18n-keys.ts');

function generateKeys(obj, prefix = '') {
  let keys = [];
  for (const [key, value] of Object.entries(obj)) {
    const fullKey = prefix ? `${prefix}.${key}` : key;
    if (typeof value === 'string') {
      keys.push(fullKey);
    } else if (typeof value === 'object' && value !== null) {
      keys.push(...generateKeys(value, fullKey));
    }
  }
  return keys;
}

try {
  const enContent = readFileSync(enPath, 'utf-8');
  const enData = JSON.parse(enContent);
  const keys = generateKeys(enData);

  const typeDefinition = `// Auto-generated by scripts/generate-i18n-types.js
// Do not edit manually - run 'yarn generate:i18n' to regenerate

export type TranslationKey =
${keys.map((k) => `  | '${k}'`).join('\n')};
`;

  writeFileSync(outputPath, typeDefinition);
  console.log(`✅ Generated ${keys.length} translation keys → ${outputPath}`);
} catch (error) {
  console.error('❌ Error generating types:', error.message);
  process.exit(1);
}
```

**Verification:** File created at `scripts/generate-i18n-types.js`

---

### Task 1.2: Create Translation Validation Script

**File:** `scripts/validate-translations.js`

**Action:** Create a script that validates both translation files have the same keys.

**Code:**

```javascript
#!/usr/bin/env node
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const enPath = join(__dirname, '../src/i18n/en.json');
const esPath = join(__dirname, '../src/i18n/es.json');

function getKeys(obj, prefix = '') {
  let keys = [];
  for (const [key, value] of Object.entries(obj)) {
    const fullKey = prefix ? `${prefix}.${key}` : key;
    if (typeof value === 'string') {
      keys.push(fullKey);
    } else if (typeof value === 'object' && value !== null) {
      keys.push(...getKeys(value, fullKey));
    }
  }
  return keys;
}

try {
  const enContent = JSON.parse(readFileSync(enPath, 'utf-8'));
  const esContent = JSON.parse(readFileSync(esPath, 'utf-8'));

  const enKeys = new Set(getKeys(enContent));
  const esKeys = new Set(getKeys(esContent));

  const missingInEs = [...enKeys].filter((k) => !esKeys.has(k));
  const missingInEn = [...esKeys].filter((k) => !enKeys.has(k));

  let hasErrors = false;

  if (missingInEs.length > 0) {
    console.error('❌ Missing in Spanish (es.json):');
    missingInEs.forEach((k) => console.error(`   - ${k}`));
    hasErrors = true;
  }

  if (missingInEn.length > 0) {
    console.error('❌ Missing in English (en.json):');
    missingInEn.forEach((k) => console.error(`   - ${k}`));
    hasErrors = true;
  }

  if (hasErrors) {
    console.error('\n❌ Translation validation failed!');
    process.exit(1);
  }

  console.log(`✅ All translations valid! (${enKeys.size} keys in each language)`);
} catch (error) {
  console.error('❌ Error validating translations:', error.message);
  process.exit(1);
}
```

**Verification:** File created at `scripts/validate-translations.js`

---

### Task 1.3: Update package.json Scripts

**File:** `package.json`

**Action:** Add new scripts for type generation and validation, and update pre-commit hooks.

**Changes to scripts:**

```json
{
  "scripts": {
    "dev": "yarn generate:i18n && astro dev",
    "build": "yarn generate:i18n && astro check && astro build",
    "generate:i18n": "node scripts/generate-i18n-types.js",
    "validate:i18n": "node scripts/validate-translations.js",
    "check": "yarn validate:i18n && astro check && yarn lint && yarn format:check"
  }
}
```

**Changes to lint-staged (pre-commit hooks):**

```json
{
  "lint-staged": {
    "src/i18n/*.json": [
      "yarn validate:i18n",
      "yarn generate:i18n",
      "git add src/lib/i18n-keys.ts",
      "prettier --write"
    ],
    "*.{js,ts,astro}": ["eslint --fix", "prettier --write"],
    "*.{json,md,css}": ["prettier --write"]
  }
}
```

**Why:** This ensures that whenever translation JSON files change, pre-commit will:

1. Validate both files have matching keys
2. Regenerate TypeScript types
3. Stage the generated types file
4. Format the JSON

**Verification:** Run `yarn generate:i18n` and verify it creates `src/lib/i18n-keys.ts`

---

### Task 1.4: Update i18n.ts to Use Type-Safe Keys

**File:** `src/lib/i18n.ts`

**Action:** Import the generated types and add type safety to the `t()` function.

**Changes:**

```typescript
import { getCollection, type CollectionEntry } from 'astro:content';
import en from '../i18n/en.json';
import es from '../i18n/es.json';
import type { TranslationKey } from './i18n-keys';

export type Locale = 'en' | 'es';

const translations: Record<Locale, typeof en> = {
  en,
  es,
};

/**
 * Extract locale from URL pathname
 * /en/blog -> 'en'
 * /blog -> 'es' (Spanish is now default)
 */
export function getLocaleFromUrl(url: URL): Locale {
  const pathname = url.pathname;
  // English now has the prefix
  if (pathname.startsWith('/en/') || pathname === '/en') {
    return 'en';
  }
  // Spanish is default (no prefix)
  return 'es';
}

/**
 * Get translation for a key using dot notation
 * t('es', 'nav.home') -> 'Inicio'
 * t('en', 'nav.home') -> 'Home'
 */
export function t(locale: Locale, key: TranslationKey, vars?: Record<string, string>): string {
  const keys = key.split('.');
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  let value: any = translations[locale];

  for (const k of keys) {
    if (value && typeof value === 'object' && k in value) {
      value = value[k];
    } else {
      console.warn(`Translation key not found: ${key} for locale ${locale}`);
      return key;
    }
  }

  if (typeof value !== 'string') {
    console.warn(`Translation value is not a string: ${key}`);
    return key;
  }

  // Replace variables like {year}
  if (vars) {
    return value.replace(/\{(\w+)\}/g, (match, varName) => {
      return vars[varName] || match;
    });
  }

  return value;
}

/**
 * Generate URL for alternate language
 * getAlternateUrl('/blog/my-post', 'es', 'en') -> '/en/blog/my-post'
 * getAlternateUrl('/en/blog/my-post', 'en', 'es') -> '/blog/my-post'
 */
export function getAlternateUrl(
  currentPath: string,
  _currentLocale: Locale,
  targetLocale: Locale
): string {
  // If switching to Spanish (default), remove /en prefix
  if (targetLocale === 'es') {
    return currentPath.replace(/^\/en(\/|$)/, '/') || '/';
  }

  // If switching to English, add /en prefix
  if (targetLocale === 'en') {
    // Remove any existing /en prefix first
    const cleanPath = currentPath.replace(/^\/en(\/|$)/, '/');
    return `/en${cleanPath === '/' ? '' : cleanPath}`;
  }

  return currentPath;
}

/**
 * Extract translation key from post ID
 * e.g., "welcome-post-2025/en.md" -> "welcome-post-2025"
 */
export function getTranslationKey(post: CollectionEntry<'blog'>): string {
  const cleanId = post.id.replace(/\.mdx?$/, '');
  const parts = cleanId.split('/');
  return parts[0];
}

/**
 * Find translated blog post by looking for sibling in same folder
 */
export async function getTranslatedPost(
  post: CollectionEntry<'blog'>,
  targetLocale: Locale
): Promise<CollectionEntry<'blog'> | null> {
  const translationKey = getTranslationKey(post);
  const allPosts = await getCollection('blog');

  const translated = allPosts.find(
    (p) => getTranslationKey(p) === translationKey && p.data.locale === targetLocale
  );

  return translated || null;
}

/**
 * Get the custom URL slug from post frontmatter
 */
export function getPostSlug(post: CollectionEntry<'blog'>): string {
  return post.data.slug;
}

/**
 * Build blog post URL based on locale
 * Spanish (default): /blog/slug
 * English: /en/blog/slug
 */
export function getBlogPostUrl(post: CollectionEntry<'blog'>): string {
  const slug = post.data.slug;
  const locale = post.data.locale || 'es'; // Default to Spanish

  if (locale === 'en') {
    return `/en/blog/${slug}`;
  }
  return `/blog/${slug}`;
}

/**
 * Helper for components that need translations
 */
export function useTranslations(locale: Locale) {
  return {
    t: (key: TranslationKey, vars?: Record<string, string>) => t(locale, key, vars),
    locale,
    formatDate: (date: Date, options?: Intl.DateTimeFormatOptions) =>
      date.toLocaleDateString(locale === 'es' ? 'es-ES' : 'en-US', options),
    formatNumber: (num: number) => num.toLocaleString(locale === 'es' ? 'es-ES' : 'en-US'),
  };
}
```

**Verification:** TypeScript should show no errors, and you should get autocomplete when using `t()`

---

## Phase 2: Configure Astro Built-in i18n

### Task 2.1: Update Astro Config

**File:** `astro.config.mjs`

**Action:** Add i18n configuration with Spanish as default.

**Changes:**

```javascript
import { defineConfig } from 'astro/config';
import vercel from '@astrojs/vercel';
import react from '@astrojs/react';
import sitemap from '@astrojs/sitemap';

export default defineConfig({
  site: 'https://chrisrodz.io',
  output: 'server',
  adapter: vercel(),
  prefetch: true,
  integrations: [
    react(),
    sitemap({
      filter: (page) => {
        // Exclude admin pages from sitemap
        if (page.includes('/admin')) return false;
        // Exclude 404 page
        if (page.includes('/404')) return false;
        return true;
      },
      i18n: {
        defaultLocale: 'es',
        locales: {
          es: 'es',
          en: 'en',
        },
      },
    }),
  ],
  i18n: {
    locales: ['es', 'en'],
    defaultLocale: 'es',
    routing: {
      prefixDefaultLocale: false, // Spanish has no prefix
    },
  },
});
```

**Verification:** Run `yarn dev` and confirm no errors

---

## Phase 3: Expand Translation Files

### Task 3.1: Expand English Translation File

**File:** `src/i18n/en.json`

**Action:** Add all hardcoded strings from the site.

**Complete Content:**

```json
{
  "site": {
    "title": "Christian Rodriguez",
    "titleWithPage": "{page} | Christian Rodriguez",
    "author": "Christian A. Rodríguez Encarnación"
  },
  "nav": {
    "home": "Home",
    "blog": "Blog",
    "about": "About",
    "cafe": "Coffee",
    "training": "Training"
  },
  "footer": {
    "copyright": "© {year} Christian A. Rodríguez Encarnación",
    "rss": "RSS",
    "email": "Email",
    "github": "GitHub"
  },
  "common": {
    "backToHome": "Back to home",
    "loading": "Loading...",
    "error": "Error",
    "notFound": "Not Found",
    "readMore": "Read more"
  },
  "home": {
    "title": "Home",
    "greeting": "Hello there!",
    "intro": {
      "paragraph1": "My name is Christian. I'm a software engineer passionate about building things that matter and make our lives better. When I'm not sitting at my desk, I'm either on my bike or spending time with family.",
      "paragraph2": "I write about software engineering, life lessons, and whatever else is worth sharing. Here's some of my latest:"
    }
  },
  "about": {
    "title": "About",
    "metaDescription": "Learn more about Christian Rodriguez - Software Engineer, Triathlete, and Dad",
    "heading": "About Me",
    "subtitle": "Software Engineer • Triathlete • Dad",
    "sections": {
      "greeting": "Hi, I'm Christian 👋",
      "intro": "I'm a software engineer passionate about building things that matter. By day, I write code and solve problems. By early morning and evening, I train for triathlons. And in between, I'm a dad trying to keep up with my kids.",
      "whatIDoTitle": "What I Do",
      "whatIDo": "I specialize in building web applications with modern technologies. I love working with TypeScript, React, and all things JavaScript/Node.js. I'm particularly interested in developer experience, performance, and creating tools that make developers' lives easier.",
      "triathlonTitle": "Triathlon Journey",
      "triathlon": "Swimming, biking, and running have become more than just hobbies—they're how I think through problems, push my limits, and stay balanced. I track my training here and share what I learn along the way.",
      "coffeeTitle": "Coffee & Code",
      "coffee": "There's something meditative about the coffee brewing process. From selecting beans to dialing in the perfect espresso shot, it's another form of problem-solving that I enjoy. I log my experiments in the",
      "coffeeLink": "coffee section",
      "blogTitle": "This Blog",
      "blog": "I write about software engineering, lessons learned from training, and whatever else seems worth sharing. The posts are a mix of technical deep-dives, training reflections, and occasional life updates.",
      "connectTitle": "Let's Connect",
      "connect": "I'm always happy to chat about code, triathlon, coffee, or anything in between. You can find me on:",
      "githubLabel": "GitHub:",
      "emailLabel": "Email:"
    }
  },
  "blog": {
    "title": "Blog",
    "metaTitle": "Blog",
    "readMore": "Read more",
    "publishedOn": "Published on",
    "updatedOn": "Updated on",
    "backToAll": "← Back to all posts",
    "tags": "Tags",
    "category": "Category",
    "rssTitle": "Christian Rodriguez - Blog (English)"
  },
  "cafe": {
    "title": "Coffee Tracker",
    "metaDescription": "My coffee brewing journey - tracking beans, methods, and quality",
    "subtitle": "Tracking my coffee brewing journey, one cup at a time",
    "notAvailableTitle": "Coffee Tracking Not Available",
    "notConfigured": "The database is not configured yet. Coffee tracking will be available soon!",
    "noLogsTitle": "No Coffee Logs Yet",
    "noLogs": "The coffee tracking journey is just beginning. Check back soon for updates!",
    "stats": {
      "totalLogs": "Total Logs",
      "thisWeek": "This Week",
      "avgRating": "Avg Rating"
    },
    "charts": {
      "brewMethodTitle": "Brew Method Distribution",
      "qualityTitle": "Quality Over Time (Last 30 Days)",
      "topBeansTitle": "Most Used Beans"
    },
    "table": {
      "date": "Date",
      "bean": "Bean",
      "method": "Method",
      "ratio": "Ratio",
      "rating": "Rating",
      "notes": "Notes"
    }
  },
  "training": {
    "title": "Training Log",
    "metaTitle": "Training Log",
    "subtitle": "Triathlon training activities and metrics",
    "notAvailable": "Training tracking is not available yet. Please configure your Supabase database and Strava integration.",
    "setupButton": "Set up training tracking →",
    "table": {
      "date": "Date",
      "activity": "Activity",
      "distance": "Distance",
      "duration": "Duration",
      "elevation": "Elevation",
      "avgHr": "Avg HR"
    }
  },
  "errors": {
    "404": {
      "title": "404 - Page Not Found",
      "message": "The page you're looking for doesn't exist.",
      "backHome": "Go back home"
    }
  },
  "accessibility": {
    "toggleTheme": "Toggle theme",
    "toggleThemeTitle": "Toggle light/dark mode",
    "toggleMenu": "Toggle menu",
    "switchToSpanish": "Switch to Spanish",
    "switchToEnglish": "Cambiar a Inglés"
  },
  "languageSwitch": {
    "tooltipEs": "Haz click para cambiar a Español",
    "tooltipEn": "Click for English"
  }
}
```

**Verification:** File has valid JSON syntax

---

### Task 3.2: Expand Spanish Translation File

**File:** `src/i18n/es.json`

**Action:** Add Spanish translations for all keys.

**Complete Content:**

```json
{
  "site": {
    "title": "Christian Rodriguez",
    "titleWithPage": "{page} | Christian Rodriguez",
    "author": "Christian A. Rodríguez Encarnación"
  },
  "nav": {
    "home": "Inicio",
    "blog": "Blog",
    "about": "Acerca",
    "cafe": "Café",
    "training": "Entrenamiento"
  },
  "footer": {
    "copyright": "© {year} Christian A. Rodríguez Encarnación",
    "rss": "RSS",
    "email": "Email",
    "github": "GitHub"
  },
  "common": {
    "backToHome": "Volver al inicio",
    "loading": "Cargando...",
    "error": "Error",
    "notFound": "No Encontrado",
    "readMore": "Leer más"
  },
  "home": {
    "title": "Inicio",
    "greeting": "Saludos!",
    "intro": {
      "paragraph1": "Soy Christian, ingeniero de software apasionado por construir cosas que importan y nos faciliten la vida. Cuando no estoy sentado trabajando estoy sentado en la bicicleta o pasando tiempo en familia.",
      "paragraph2": "Escribo sobre escribir software, lecciones aprendidas de la vida, y lo que sea que valga la pena compartir. Aquí puedes ver lo más reciente:"
    }
  },
  "about": {
    "title": "Acerca",
    "metaDescription": "Conoce más sobre Christian Rodriguez - Ingeniero de Software, Triatleta, y Papá",
    "heading": "Acerca de Mí",
    "subtitle": "Ingeniero de Software • Triatleta • Papá",
    "sections": {
      "greeting": "Hola, soy Christian 👋",
      "intro": "Soy un ingeniero de software apasionado por construir cosas que importan. Durante el día, escribo código y resuelvo problemas. De madrugada y por la tarde, entreno para triatlones. Y en el medio, soy un papá tratando de mantener el ritmo de mis hijos.",
      "whatIDoTitle": "Lo Que Hago",
      "whatIDo": "Me especializo en construir aplicaciones web con tecnologías modernas. Me encanta trabajar con TypeScript, React, y todo lo relacionado con JavaScript/Node.js. Estoy particularmente interesado en la experiencia del desarrollador, rendimiento, y crear herramientas que faciliten la vida de los desarrolladores.",
      "triathlonTitle": "Mi Viaje en el Triatlón",
      "triathlon": "Nadar, montar bicicleta, y correr se han convertido en más que pasatiempos—son cómo pienso a través de problemas, empujo mis límites, y me mantengo balanceado. Registro mi entrenamiento aquí y comparto lo que aprendo en el camino.",
      "coffeeTitle": "Café y Código",
      "coffee": "Hay algo meditativo en el proceso de preparar café. Desde seleccionar los granos hasta afinar el shot de espresso perfecto, es otra forma de resolver problemas que disfruto. Registro mis experimentos en la",
      "coffeeLink": "sección de café",
      "blogTitle": "Este Blog",
      "blog": "Escribo sobre ingeniería de software, lecciones aprendidas del entrenamiento, y lo que sea que valga la pena compartir. Los posts son una mezcla de análisis técnicos profundos, reflexiones de entrenamiento, y actualizaciones ocasionales de la vida.",
      "connectTitle": "Conectemos",
      "connect": "Siempre estoy feliz de conversar sobre código, triatlón, café, o cualquier cosa entre medio. Puedes encontrarme en:",
      "githubLabel": "GitHub:",
      "emailLabel": "Email:"
    }
  },
  "blog": {
    "title": "Blog",
    "metaTitle": "Blog",
    "readMore": "Leer más",
    "publishedOn": "Publicado el",
    "updatedOn": "Actualizado el",
    "backToAll": "← Volver a todos los posts",
    "tags": "Etiquetas",
    "category": "Categoría",
    "rssTitle": "Christian Rodriguez - Blog (Español)"
  },
  "cafe": {
    "title": "Registro de Café",
    "metaDescription": "Mi jornada preparando café - registrando granos, métodos, y calidad",
    "subtitle": "Registrando mi jornada con el café, una taza a la vez",
    "notAvailableTitle": "Registro de Café No Disponible",
    "notConfigured": "La base de datos aún no está configurada. ¡El registro de café estará disponible pronto!",
    "noLogsTitle": "Sin Registros de Café Aún",
    "noLogs": "La jornada del registro de café apenas comienza. ¡Vuelve pronto para actualizaciones!",
    "stats": {
      "totalLogs": "Total de Registros",
      "thisWeek": "Esta Semana",
      "avgRating": "Calificación Promedio"
    },
    "charts": {
      "brewMethodTitle": "Distribución de Métodos de Preparación",
      "qualityTitle": "Calidad en el Tiempo (Últimos 30 Días)",
      "topBeansTitle": "Granos Más Usados"
    },
    "table": {
      "date": "Fecha",
      "bean": "Grano",
      "method": "Método",
      "ratio": "Proporción",
      "rating": "Calificación",
      "notes": "Notas"
    }
  },
  "training": {
    "title": "Registro de Entrenamiento",
    "metaTitle": "Registro de Entrenamiento",
    "subtitle": "Actividades y métricas de entrenamiento de triatlón",
    "notAvailable": "El registro de entrenamiento aún no está disponible. Por favor configura tu base de datos de Supabase e integración con Strava.",
    "setupButton": "Configurar registro de entrenamiento →",
    "table": {
      "date": "Fecha",
      "activity": "Actividad",
      "distance": "Distancia",
      "duration": "Duración",
      "elevation": "Elevación",
      "avgHr": "FC Promedio"
    }
  },
  "errors": {
    "404": {
      "title": "404 - Página No Encontrada",
      "message": "La página que buscas no existe.",
      "backHome": "Volver al inicio"
    }
  },
  "accessibility": {
    "toggleTheme": "Cambiar tema",
    "toggleThemeTitle": "Cambiar entre modo claro/oscuro",
    "toggleMenu": "Alternar menú",
    "switchToSpanish": "Cambiar a Español",
    "switchToEnglish": "Switch to English"
  },
  "languageSwitch": {
    "tooltipEs": "Haz click para cambiar a Español",
    "tooltipEn": "Click for English"
  }
}
```

**Verification:** Run `yarn validate:i18n` to ensure both files have matching keys

---

### Task 3.3: Generate Translation Types

**Action:** Run the type generation script.

```bash
yarn generate:i18n
```

**Verification:** File `src/lib/i18n-keys.ts` is created with all translation keys as types

---

### Task 3.4: Audit Accessibility Strings

**Action:** Verify all accessibility-related strings are in translation files.

**Check for:**

- Image alt attributes
- ARIA labels (already in `accessibility` section)
- Form field labels
- Button labels
- Error messages
- Loading states

**Commands:**

```bash
# Search for hardcoded alt attributes
grep -r 'alt="' src/pages/ src/components/

# Search for hardcoded aria-label
grep -r 'aria-label="' src/pages/ src/components/

# Search for hardcoded placeholder text
grep -r 'placeholder="' src/pages/ src/components/
```

**Verification:**

- Document any hardcoded accessibility strings found
- Add them to translation files if needed
- Most accessibility strings should already be in `en.json` and `es.json`

---

### Task 3.5: Verify Date/Time Formatting Consistency

**Action:** Ensure all date displays use the `formatDate` helper from `useTranslations()`.

**Commands:**

```bash
# Search for raw date formatting calls
grep -r 'toLocaleDateString' src/pages/ src/components/
grep -r 'toLocaleString' src/pages/ src/components/
grep -r 'toLocaleTimeString' src/pages/ src/components/
```

**Expected:** All date formatting should use `formatDate()` from `useTranslations()` helper

**Verification:**

- Review search results
- Replace any raw date formatting with `formatDate()` helper
- Ensures consistent locale-aware date formatting

---

## Phase 4: Update Middleware

### Task 4.1: Update Middleware for Spanish Default

**File:** `src/middleware.ts`

**Action:** Flip the redirect logic to make Spanish the default.

**Complete Content:**

```typescript
import { defineMiddleware } from 'astro:middleware';

export const onRequest = defineMiddleware(async (context, next) => {
  const { request, redirect, cookies, url } = context;

  // 1. Check if user has manually selected a language (respect user choice)
  const langPreference = cookies.get('preferred-lang')?.value;
  if (langPreference) {
    // User has a preference set, don't redirect
    return next();
  }

  // 2. Only redirect on homepage to avoid breaking deep links
  // Allow redirects from both / and /en to properly handle Accept-Language
  if (url.pathname !== '/' && url.pathname !== '/en') {
    return next();
  }

  // 3. Check Accept-Language header (W3C standard) with robust parsing
  const acceptLang = request.headers.get('accept-language') || '';

  // Parse Accept-Language header more robustly
  // Handles cases like: "es-MX, es-419, es;q=0.9, en;q=0.8"
  const languages = acceptLang
    .split(',')
    .map((lang) => lang.split(';')[0].trim().toLowerCase())
    .filter((lang) => lang.length > 0);

  const browserPrefersEnglish = languages.some((lang) => lang.startsWith('en'));

  // 4. Redirect logic based on browser language preference
  // FLIPPED: Spanish is now default
  if (browserPrefersEnglish && url.pathname === '/') {
    // User prefers English and is on Spanish homepage -> redirect to English
    return redirect('/en', 302);
  }

  if (!browserPrefersEnglish && url.pathname === '/en') {
    // User prefers Spanish and is on English homepage -> redirect to Spanish
    return redirect('/', 302);
  }

  // No redirect needed, proceed with request
  return next();
});
```

**Verification:** Middleware compiles without errors

---

### Task 4.2: Add URL Redirects for Old English URLs

**File:** `vercel.json` (create if doesn't exist at root)

**Action:** Add redirects for old English URLs without `/en/` prefix to maintain backward compatibility.

**Note:** This assumes the site was previously live with English as default. If the site hasn't been deployed yet, this task can be skipped.

**Code:**

```json
{
  "redirects": [
    {
      "source": "/about",
      "has": [
        {
          "type": "header",
          "key": "accept-language",
          "value": "en.*"
        }
      ],
      "destination": "/en/about",
      "permanent": false
    },
    {
      "source": "/cafe",
      "has": [
        {
          "type": "header",
          "key": "accept-language",
          "value": "en.*"
        }
      ],
      "destination": "/en/cafe",
      "permanent": false
    },
    {
      "source": "/training",
      "has": [
        {
          "type": "header",
          "key": "accept-language",
          "value": "en.*"
        }
      ],
      "destination": "/en/training",
      "permanent": false
    }
  ]
}
```

**Alternative approach:** If you want simpler permanent redirects for specific old URLs:

```json
{
  "redirects": [
    {
      "source": "/old-english-about-url",
      "destination": "/en/about",
      "permanent": true
    }
  ]
}
```

**Verification:**

- File created (if needed)
- Redirects configured for any known old URLs
- Test after deployment

**Decision:** Determine if redirects are needed based on:

- Was the site publicly accessible before?
- Do analytics show traffic to old URLs?
- Are there external links pointing to old URLs?

---

## Phase 5: Update Layout Component

### Task 5.1: Update Layout to Use Translations

**File:** `src/layouts/Layout.astro`

**Action:** Replace hardcoded strings with translation function calls.

**Key Changes:**

1. Import translation function
2. Extract locale from URL
3. Replace all hardcoded text with `t()` calls
4. Update language switcher logic
5. Update meta tags

**Updated Content:**

```astro
---
import '../styles/global.css';
import { getLocaleFromUrl, t, getAlternateUrl, type Locale } from '@/lib/i18n';

export interface Props {
  title: string;
  description?: string;
  image?: string;
  alternateUrl?: string; // Optional: for translated pages with different slugs
}

const locale: Locale = getLocaleFromUrl(Astro.url);
const {
  title,
  description = t(locale, 'home.intro.paragraph1'),
  image = '/og-image.png',
  alternateUrl: providedAlternateUrl,
} = Astro.props;
const currentPath = Astro.url.pathname;
const canonicalURL = new URL(currentPath, Astro.site || 'https://chrisrodz.io');
const ogImage = new URL(image, Astro.site || 'https://chrisrodz.io');

// Generate alternate language URLs
const alternateLocale: Locale = locale === 'es' ? 'en' : 'es';
// Use provided alternateUrl (e.g., for translated blog posts) or generate one
const alternateUrl = providedAlternateUrl || getAlternateUrl(currentPath, locale, alternateLocale);
const alternateFullUrl = new URL(alternateUrl, Astro.site || 'https://chrisrodz.io');

// Format title with site name
const fullTitle = t(locale, 'site.titleWithPage', { page: title });
const currentYear = new Date().getFullYear().toString();
---

<!doctype html>
<html lang={locale}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />

    <!-- Sitemap -->
    <link rel="sitemap" type="application/xml" href="/sitemap-index.xml" />

    <!-- RSS Feed -->
    <link
      rel="alternate"
      type="application/rss+xml"
      title={t('en', 'blog.rssTitle')}
      href="/en/rss.xml"
    />
    <link
      rel="alternate"
      type="application/rss+xml"
      title={t('es', 'blog.rssTitle')}
      href="/rss.xml"
    />

    <!-- Alternate language links for SEO -->
    <link rel="alternate" hreflang={locale} href={canonicalURL} />
    <link rel="alternate" hreflang={alternateLocale} href={alternateFullUrl} />
    <link
      rel="alternate"
      hreflang="x-default"
      href={new URL('/', Astro.site || 'https://chrisrodz.io')}
    />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={fullTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={ogImage} />

    <title>{fullTitle}</title>

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Crimson+Text:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Pico CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />

    <!-- Theme script (prevent FOUC) -->
    <script is:inline>
      const theme = localStorage.getItem('theme') || 'light';
      if (theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    </script>
  </head>
  <body>
    <nav class="container main-nav">
      <ul>
        <li>
          <a
            href={locale === 'en' ? '/en' : '/'}
            class={currentPath === '/' || currentPath === '/en' ? 'active' : ''}
            >{t(locale, 'nav.home')}</a
          >
        </li>
      </ul>
      <ul class="nav-links">
        <li class="nav-actions">
          <button
            id="theme-toggle"
            aria-label={t(locale, 'accessibility.toggleTheme')}
            class="contrast icon-button"
            title={t(locale, 'accessibility.toggleThemeTitle')}
          >
            <span id="theme-icon" aria-hidden="true">🌙</span>
          </button>
        </li>
        <li class="nav-actions">
          <a
            id="lang-toggle"
            href={alternateUrl}
            class="lang-toggle"
            data-target-lang={locale === 'es' ? 'en' : 'es'}
            data-tooltip={t(
              locale,
              locale === 'es' ? 'languageSwitch.tooltipEn' : 'languageSwitch.tooltipEs'
            )}
            data-placement="bottom"
            aria-label={t(
              locale,
              locale === 'es' ? 'accessibility.switchToEnglish' : 'accessibility.switchToSpanish'
            )}
          >
            <span class="lang-icon" aria-hidden="true">{locale === 'es' ? '🇺🇸' : '🇵🇷'}</span>
            <span class="lang-text">{locale === 'es' ? 'EN' : 'ES'}</span>
          </a>
        </li>
      </ul>
      <button
        id="mobile-menu-toggle"
        class="mobile-menu-toggle"
        aria-label={t(locale, 'accessibility.toggleMenu')}
        aria-expanded="false"
      >
        <span class="hamburger-icon"></span>
      </button>
    </nav>

    <main class="container">
      <slot />
    </main>

    <footer
      class="container"
      style="margin-top: 4rem; padding: 2rem 0; border-top: 1px solid var(--pico-muted-border-color);"
    >
      <div
        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"
      >
        <p style="color: var(--pico-muted-color); margin: 0;">
          {t(locale, 'footer.copyright', { year: currentYear })}
        </p>
        <div style="display: flex; gap: 1.5rem;">
          <a href="/rss.xml" style="color: var(--pico-muted-color); text-decoration: none;">
            {t(locale, 'footer.rss')}
          </a>
          <a
            href="mailto:hey@chrisrodz.io"
            style="color: var(--pico-muted-color); text-decoration: none;"
          >
            {t(locale, 'footer.email')}
          </a>
          <a
            href="https://github.com/chrisrodz"
            target="_blank"
            rel="noopener noreferrer"
            style="color: var(--pico-muted-color); text-decoration: none;"
          >
            {t(locale, 'footer.github')}
          </a>
        </div>
      </div>
    </footer>

    <!-- Dark mode toggle script -->
    <script is:inline>
      const themeToggle = document.getElementById('theme-toggle');
      const themeIcon = document.getElementById('theme-icon');
      const html = document.documentElement;

      function setTheme(theme) {
        if (theme === 'dark') {
          html.setAttribute('data-theme', 'dark');
          themeIcon.textContent = '☀️';
        } else {
          html.setAttribute('data-theme', 'light');
          themeIcon.textContent = '🌙';
        }
        localStorage.setItem('theme', theme);
      }

      const currentTheme = html.getAttribute('data-theme') || 'light';
      themeIcon.textContent = currentTheme === 'dark' ? '☀️' : '🌙';

      themeToggle?.addEventListener('click', () => {
        const current = html.getAttribute('data-theme') || 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        setTheme(next);
      });
    </script>

    <!-- Language switcher script -->
    <script is:inline>
      const langToggle = document.getElementById('lang-toggle');

      langToggle?.addEventListener('click', () => {
        const targetLang = langToggle.getAttribute('data-target-lang');
        const expires = new Date();
        expires.setFullYear(expires.getFullYear() + 1);
        document.cookie = `preferred-lang=${targetLang}; path=/; expires=${expires.toUTCString()}; SameSite=Lax`;
      });
    </script>

    <!-- Mobile menu toggle script -->
    <script is:inline>
      const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
      const navLinks = document.querySelector('.nav-links');

      mobileMenuToggle?.addEventListener('click', () => {
        const isExpanded = mobileMenuToggle.getAttribute('aria-expanded') === 'true';
        mobileMenuToggle.setAttribute('aria-expanded', !isExpanded);
        navLinks?.classList.toggle('active');
        mobileMenuToggle.classList.toggle('active');
      });

      navLinks?.querySelectorAll('a').forEach((link) => {
        link.addEventListener('click', () => {
          navLinks.classList.remove('active');
          mobileMenuToggle?.classList.remove('active');
          mobileMenuToggle?.setAttribute('aria-expanded', 'false');
        });
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.main-nav')) {
          navLinks?.classList.remove('active');
          mobileMenuToggle?.classList.remove('active');
          mobileMenuToggle?.setAttribute('aria-expanded', 'false');
        }
      });
    </script>
  </body>
</html>
```

**Verification:** Layout compiles without TypeScript errors

---

### Task 5.2: Audit React Components for Hardcoded Strings

**Action:** Search for React components (.tsx/.jsx files) and identify any hardcoded text that needs translation.

**Commands:**

```bash
# Find all React component files
find src/components -type f \( -name "*.tsx" -o -name "*.jsx" \)

# Search for potential hardcoded strings (exclude imports)
grep -r --include="*.tsx" --include="*.jsx" '"[A-Za-z]' src/components/ | grep -v "import"
```

**Expected React components (from cafe page):**

- Chart components (if any)
- Coffee log table components (if any)
- Any other interactive UI components

**Analysis:**

1. List all React components found
2. Check each for hardcoded text strings
3. Identify which need translation

**Solution approaches:**

- **Option A:** Pass `locale` and `t` function as props to components
- **Option B:** Use translation context (if implementing React context)
- **Option C:** Keep chart labels in English (common for data viz)

**Verification:**

- Document all React components
- Note which have hardcoded strings
- Plan how to pass translations (usually via props)
- Update components if needed

---

## Phase 6: Consolidate and Update Pages

### Task 6.1: Update Homepage (Consolidate Both Locales)

**File:** `src/pages/index.astro`

**Action:** Make this page handle both locales dynamically.

**Complete Content:**

```astro
---
import Layout from '../layouts/Layout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { getBlogPostUrl, getLocaleFromUrl, useTranslations } from '@/lib/i18n';

const locale = getLocaleFromUrl(Astro.url);
const { t, formatDate } = useTranslations(locale);

// Fetch blog posts for current locale
let allPosts: CollectionEntry<'blog'>[] = [];
try {
  const posts = await getCollection('blog', ({ data }) => data.locale === locale);
  allPosts = posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
} catch (e) {
  console.warn('No blog posts found:', e);
}
---

<Layout title={t('home.title')}>
  <section style="margin-top: 3rem; margin-bottom: 4rem;">
    <h1
      style="font-family: var(--pico-font-family-serif); font-size: clamp(2rem, 4vw, 2.5rem); font-weight: 600; margin-bottom: 1.5rem;"
    >
      {t('home.greeting')}
    </h1>

    <div style="max-width: 65ch;">
      <p
        style="font-size: 1.125rem; line-height: 1.8; color: var(--pico-color); margin-bottom: 1.5rem;"
      >
        {t('home.intro.paragraph1')}
      </p>

      <p style="font-size: 1.125rem; line-height: 1.8; color: var(--pico-color);">
        {t('home.intro.paragraph2')}
      </p>
    </div>
  </section>

  {
    allPosts.length > 0 && (
      <section>
        <ul class="post-list" style="list-style: none; padding: 0; margin: 0;">
          {allPosts.map((post) => (
            <li style="padding: 1.25rem 0; border-bottom: 1px solid var(--pico-muted-border-color); display: flex; align-items: baseline; gap: 1.5rem; flex-wrap: wrap;">
              <time
                datetime={post.data.pubDate.toISOString()}
                style="font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; color: var(--pico-muted-color); min-width: 100px; flex-shrink: 0;"
              >
                {formatDate(post.data.pubDate, {
                  year: 'numeric',
                  month: 'short',
                })}
              </time>
              <a
                href={getBlogPostUrl(post)}
                style="font-family: var(--pico-font-family-serif); font-size: 1.125rem; font-weight: 600; text-decoration: none; color: var(--pico-color); flex: 1;"
              >
                {post.data.title}
              </a>
              {post.data.category && (
                <span style="font-size: 0.75rem; padding: 0.125rem 0.5rem; background: var(--pico-secondary-background); border-radius: 3px; color: var(--pico-muted-color);">
                  {post.data.category}
                </span>
              )}
            </li>
          ))}
        </ul>
      </section>
    )
  }
</Layout>
```

**Verification:** Homepage works for both `/` (Spanish) and `/en/` (English)

---

### Task 6.2: Create English Homepage

**File:** `src/pages/en/index.astro`

**Action:** Create a simple redirect/pass-through that uses the main index.

**Complete Content:**

```astro
---
// This page is for /en/ route
// The main index.astro will handle rendering based on locale detection
import Index from '../index.astro';
---

<Index {...Astro.props} />
```

**Verification:** `/en` route works correctly

---

### Task 6.3: Delete Spanish Homepage Duplicate

**Action:** Delete the duplicate Spanish homepage.

```bash
rm src/pages/es/index.astro
```

**Verification:** File no longer exists

---

### Task 6.4: Update About Page

**File:** `src/pages/about.astro`

**Action:** Make it handle both locales dynamically.

**Complete Content:**

```astro
---
import Layout from '../layouts/Layout.astro';
import { getLocaleFromUrl, useTranslations } from '@/lib/i18n';

const locale = getLocaleFromUrl(Astro.url);
const { t } = useTranslations(locale);
---

<Layout title={t('about.title')} description={t('about.metaDescription')}>
  <article style="max-width: 70ch; margin: 0 auto;">
    <header class="hero">
      <h1>{t('about.heading')}</h1>
      <p>{t('about.subtitle')}</p>
    </header>

    <div class="prose" style="margin-top: 3rem;">
      <h2>{t('about.sections.greeting')}</h2>

      <p>
        {t('about.sections.intro')}
      </p>

      <h3>{t('about.sections.whatIDoTitle')}</h3>

      <p>
        {t('about.sections.whatIDo')}
      </p>

      <h3>{t('about.sections.triathlonTitle')}</h3>

      <p>
        {t('about.sections.triathlon')}
      </p>

      <h3>{t('about.sections.coffeeTitle')}</h3>

      <p>
        {t('about.sections.coffee')}
        <a href={locale === 'en' ? '/en/cafe' : '/cafe'}>{t('about.sections.coffeeLink')}</a>.
      </p>

      <h3>{t('about.sections.blogTitle')}</h3>

      <p>
        {t('about.sections.blog')}
      </p>

      <h3>{t('about.sections.connectTitle')}</h3>

      <p>
        {t('about.sections.connect')}
      </p>

      <ul>
        <li>
          <strong>{t('about.sections.githubLabel')}</strong>
          <a href="https://github.com/chrisrodz" target="_blank" rel="noopener noreferrer">
            @chrisrodz
          </a>
        </li>
        <li>
          <strong>{t('about.sections.emailLabel')}</strong>
          <a href="mailto:hey@chrisrodz.io">hey@chrisrodz.io</a>
        </li>
      </ul>

      <hr style="margin: 3rem 0;" />

      <p style="text-align: center;">
        <a href={locale === 'en' ? '/en' : '/'} role="button">{t('common.backToHome')}</a>
      </p>
    </div>
  </article>
</Layout>
```

**Verification:** About page works for both locales

---

### Task 6.5: Create English About Page

**File:** `src/pages/en/about.astro`

**Action:** Create pass-through for English route.

**Complete Content:**

```astro
---
import About from '../about.astro';
---

<About {...Astro.props} />
```

**Verification:** `/en/about` route works

---

### Task 6.6: Delete Spanish About Duplicate

**Action:** Delete duplicate Spanish about page.

```bash
rm src/pages/es/about.astro
```

**Verification:** File deleted

---

### Task 6.7: Update Cafe Page

**File:** `src/pages/cafe.astro`

**Action:** Add full locale support to the cafe page.

**Complete implementation steps:**

1. **Add imports at the top:**

```typescript
import { getLocaleFromUrl, useTranslations } from '@/lib/i18n';
```

2. **Add locale detection after other const declarations:**

```typescript
const locale = getLocaleFromUrl(Astro.url);
const { t } = useTranslations(locale);
```

3. **Replace all hardcoded strings with translation calls:**

| Original Text                             | Replace With                         |
| ----------------------------------------- | ------------------------------------ |
| `"Coffee Tracker"`                        | `{t('cafe.title')}`                  |
| `"Tracking my coffee brewing journey..."` | `{t('cafe.subtitle')}`               |
| `"Coffee Tracking Not Available"`         | `{t('cafe.notAvailableTitle')}`      |
| `"The database is not configured..."`     | `{t('cafe.notConfigured')}`          |
| `"No Coffee Logs Yet"`                    | `{t('cafe.noLogsTitle')}`            |
| `"The coffee tracking journey..."`        | `{t('cafe.noLogs')}`                 |
| `"Total Logs"`                            | `{t('cafe.stats.totalLogs')}`        |
| `"This Week"`                             | `{t('cafe.stats.thisWeek')}`         |
| `"Avg Rating"`                            | `{t('cafe.stats.avgRating')}`        |
| `"Brew Method Distribution"`              | `{t('cafe.charts.brewMethodTitle')}` |
| `"Quality Over Time (Last 30 Days)"`      | `{t('cafe.charts.qualityTitle')}`    |
| `"Most Used Beans"`                       | `{t('cafe.charts.topBeansTitle')}`   |
| `"Date"`                                  | `{t('cafe.table.date')}`             |
| `"Bean"`                                  | `{t('cafe.table.bean')}`             |
| `"Method"`                                | `{t('cafe.table.method')}`           |
| `"Ratio"`                                 | `{t('cafe.table.ratio')}`            |
| `"Rating"`                                | `{t('cafe.table.rating')}`           |
| `"Notes"`                                 | `{t('cafe.table.notes')}`            |

4. **Update Layout component call:**

```astro
<Layout title={t('cafe.title')} description={t('cafe.metaDescription')} />
```

5. **If React components are used for charts:**
   Pass `t` function as prop:

```typescript
<CoffeeChart
  data={chartData}
  title={t('cafe.charts.brewMethodTitle')}
/>
```

**Verification:**

- Run `yarn dev` and visit `/cafe` and `/en/cafe`
- Verify all text is translated correctly
- Check that error messages appear in correct language
- No TypeScript errors

---

### Task 6.8: Update Training Page

**File:** `src/pages/training.astro`

**Action:** Add full locale support to training page.

**Complete implementation steps:**

1. **Add imports at the top:**

```typescript
import { getLocaleFromUrl, useTranslations } from '@/lib/i18n';
```

2. **Add locale detection:**

```typescript
const locale = getLocaleFromUrl(Astro.url);
const { t, formatDate } = useTranslations(locale);
```

3. **Replace all hardcoded strings:**

| Original Text                             | Replace With                      |
| ----------------------------------------- | --------------------------------- |
| `"Training Log"`                          | `{t('training.title')}`           |
| `"Triathlon training activities..."`      | `{t('training.subtitle')}`        |
| `"Training tracking is not available..."` | `{t('training.notAvailable')}`    |
| `"Set up training tracking →"`            | `{t('training.setupButton')}`     |
| `"Date"`                                  | `{t('training.table.date')}`      |
| `"Activity"`                              | `{t('training.table.activity')}`  |
| `"Distance"`                              | `{t('training.table.distance')}`  |
| `"Duration"`                              | `{t('training.table.duration')}`  |
| `"Elevation"`                             | `{t('training.table.elevation')}` |
| `"Avg HR"`                                | `{t('training.table.avgHr')}`     |

4. **Update Layout component call:**

```astro
<Layout title={t('training.title')} description={t('training.subtitle')} />
```

5. **Format dates using helper:**
   If displaying activity dates, use:

```astro
{formatDate(activity.date, { year: 'numeric', month: 'short', day: 'numeric' })}
```

**Verification:**

- Run `yarn dev` and visit `/training` and `/en/training`
- Verify all text is translated correctly
- Check date formatting uses locale-aware helper
- No TypeScript errors

---

### Task 6.9: Update 404 Page

**File:** `src/pages/404.astro`

**Action:** Add locale support to 404 page.

**Complete Content:**

```astro
---
import Layout from '../layouts/Layout.astro';
import { getLocaleFromUrl, useTranslations } from '@/lib/i18n';

const locale = getLocaleFromUrl(Astro.url);
const { t } = useTranslations(locale);
---

<Layout title={t('errors.404.title')}>
  <div style="text-align: center; padding: 4rem 0;">
    <h1 style="font-size: 6rem; margin: 0;">404</h1>
    <p style="font-size: 1.5rem; margin: 2rem 0;">
      {t('errors.404.message')}
    </p>
    <a href={locale === 'en' ? '/en' : '/'} role="button">
      {t('errors.404.backHome')}
    </a>
  </div>
</Layout>
```

**Verification:** 404 page works in both languages

---

### Task 6.10: Document Admin Pages Decision

**Action:** Decide on localization strategy for admin pages.

**Current admin pages:**

- `/admin/cafe` - Coffee log admin interface

**Options:**

**Option A: Keep Admin English-Only (Recommended)**

- Admins typically understand English
- Simplifies admin interface maintenance
- Focus translation efforts on public-facing pages

**Option B: Translate Admin Interface**

- Add admin-specific translations to JSON files
- Follow same pattern as other pages

**Decision:** Document the chosen approach

**If choosing Option A (English-only):**

1. Add comment at top of admin pages:

```astro
---
// Admin interface - English only
// Uses getLocaleFromUrl for consistency but displays in English
import { getLocaleFromUrl } from '@/lib/i18n';
const locale = 'en'; // Force English for admin
---
```

**If choosing Option B (Translated):**

1. Add admin translations to `en.json` and `es.json`:

```json
{
  "admin": {
    "cafe": {
      "title": "Coffee Admin",
      "addNew": "Add New Entry"
      // ... more admin strings
    }
  }
}
```

2. Update admin pages with full locale support

**Verification:**

- Document decision in this plan
- Update admin pages accordingly
- Test admin interface works correctly

**Recommendation:** Choose Option A (English-only) to reduce complexity.

---

## Phase 7: Update Blog Routes

### Task 7.1: Update Blog Post Dynamic Route

**File:** `src/pages/blog/[slug].astro`

**Action:** Ensure it works with Spanish as default.

**Key Check:** Verify `getBlogPostUrl()` function is being used correctly.

---

### Task 7.2: Update English Blog Dynamic Route

**File:** `src/pages/en/blog/[slug].astro`

**Action:** Verify it handles English posts correctly.

---

### Task 7.3: Update Content Collection Default Locale

**File:** `src/content/config.ts`

**Action:** Change default locale to Spanish.

**Changes:**

```typescript
export const collections = {
  blog: defineCollection({
    type: 'content',
    schema: z.object({
      // ... other fields
      locale: z.enum(['en', 'es']).default('es'), // Changed from 'en'
    }),
  }),
};
```

**Verification:** Schema compiles without errors

---

## Phase 8: Update RSS Feeds

### Task 8.1: Update Spanish RSS Feed (Default)

**File:** `src/pages/rss.xml.ts`

**Action:** Ensure Spanish RSS feed is properly configured at root `/rss.xml`.

**Complete implementation:**

```typescript
import rss from '@astrojs/rss';
import { getCollection } from 'astro:content';
import type { APIRoute } from 'astro';

export const GET: APIRoute = async (context) => {
  const posts = await getCollection('blog', ({ data }) => {
    return data.locale === 'es'; // Spanish posts only
  });

  const sortedPosts = posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  return rss({
    title: 'Christian Rodriguez - Blog (Español)',
    description: 'Escritos sobre ingeniería de software, triatlón, y lecciones de vida',
    site: context.site || 'https://chrisrodz.io',
    items: sortedPosts.map((post) => ({
      title: post.data.title,
      description: post.data.description,
      pubDate: post.data.pubDate,
      link: `/blog/${post.data.slug}`,
      categories: post.data.tags,
    })),
    customData: `<language>es</language>`,
  });
};
```

**Key changes:**

- Filter for `locale === 'es'`
- Spanish title and description
- Link format: `/blog/slug` (no prefix)
- Language tag: `<language>es</language>`

**Verification:**

- Visit `http://localhost:4321/rss.xml`
- Verify XML is valid
- Check all posts are Spanish
- Verify links have no `/es/` prefix

---

### Task 8.2: Update English RSS Feed

**File:** `src/pages/en/rss.xml.ts`

**Action:** Create/update English RSS feed at `/en/rss.xml`.

**Complete implementation:**

```typescript
import rss from '@astrojs/rss';
import { getCollection } from 'astro:content';
import type { APIRoute } from 'astro';

export const GET: APIRoute = async (context) => {
  const posts = await getCollection('blog', ({ data }) => {
    return data.locale === 'en'; // English posts only
  });

  const sortedPosts = posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  return rss({
    title: 'Christian Rodriguez - Blog (English)',
    description: 'Writings on software engineering, triathlon, and life lessons',
    site: context.site || 'https://chrisrodz.io',
    items: sortedPosts.map((post) => ({
      title: post.data.title,
      description: post.data.description,
      pubDate: post.data.pubDate,
      link: `/en/blog/${post.data.slug}`,
      categories: post.data.tags,
    })),
    customData: `<language>en</language>`,
  });
};
```

**Key changes:**

- Filter for `locale === 'en'`
- English title and description
- Link format: `/en/blog/slug` (with prefix)
- Language tag: `<language>en</language>`

**Verification:**

- Visit `http://localhost:4321/en/rss.xml`
- Verify XML is valid
- Check all posts are English
- Verify links have `/en/` prefix

---

### Task 8.3: Verify RSS Links in Layout

**File:** `src/layouts/Layout.astro`

**Action:** Verify RSS feed links in `<head>` are correct (should already be updated in Task 5.1).

**Check for:**

```astro
<!-- RSS Feed -->
<link
  rel="alternate"
  type="application/rss+xml"
  title={t('en', 'blog.rssTitle')}
  href="/en/rss.xml"
/>
<link rel="alternate" type="application/rss+xml" title={t('es', 'blog.rssTitle')} href="/rss.xml" />
```

**Verification:** Both RSS links present in Layout

---

## Phase 9: Testing & Verification

### Task 9.1: Run Type Generation

**Action:**

```bash
yarn generate:i18n
```

**Expected:** No errors, types generated successfully

---

### Task 9.2: Run Translation Validation

**Action:**

```bash
yarn validate:i18n
```

**Expected:** All translations valid, matching keys in both files

---

### Task 9.3: Run Type Check

**Action:**

```bash
yarn astro check
```

**Expected:** No TypeScript errors

---

### Task 9.4: Run Linter

**Action:**

```bash
yarn lint
```

**Expected:** No linting errors

---

### Task 9.5: Run Formatter Check

**Action:**

```bash
yarn format:check
```

**Expected:** All files properly formatted

---

### Task 9.6: Start Development Server in Background

**Action:**

```bash
yarn dev
```

**Note:** Start the dev server in the background. Wait 10-15 seconds for it to fully start.

**Expected:** Server starts on `http://localhost:4321`

**Verification:** Once started, proceed to browser testing tasks below.

---

## Phase 9A: Automated Browser Testing with Chrome DevTools MCP

**Note:** These tasks use Chrome DevTools MCP for automated testing. Each task should verify functionality and capture evidence.

### Task 9A.1: Test Spanish Homepage (Default)

**Action:** Open browser and test Spanish homepage.

**Steps:**

1. Use `mcp__chrome-devtools__navigate_page` to go to `http://localhost:4321/`
2. Use `mcp__chrome-devtools__take_snapshot` to capture page content
3. Verify snapshot contains:
   - Spanish greeting: "Saludos!"
   - Spanish intro text
   - Spanish navigation: "Inicio"
4. Use `mcp__chrome-devtools__list_console_messages` to check for errors
5. Use `mcp__chrome-devtools__take_screenshot` and save to `/tmp/homepage-spanish.png`

**Expected Results:**

- Page loads successfully
- Content is in Spanish
- No console errors
- Screenshot shows Spanish content

---

### Task 9A.2: Test English Homepage

**Action:** Navigate to English homepage and verify.

**Steps:**

1. Use `mcp__chrome-devtools__navigate_page` to go to `http://localhost:4321/en`
2. Use `mcp__chrome-devtools__take_snapshot` to capture page content
3. Verify snapshot contains:
   - English greeting: "Hello there!"
   - English intro text
   - English navigation: "Home"
4. Check `<html lang="en">` attribute
5. Use `mcp__chrome-devtools__list_console_messages` to check for errors
6. Use `mcp__chrome-devtools__take_screenshot` and save to `/tmp/homepage-english.png`

**Expected Results:**

- Page loads with English content
- HTML lang attribute is "en"
- No console errors

---

### Task 9A.3: Test Language Switcher on Homepage

**Action:** Test language switcher functionality.

**Steps:**

1. Navigate to `http://localhost:4321/` (Spanish homepage)
2. Use `mcp__chrome-devtools__take_snapshot` to find language switcher element
3. Use `mcp__chrome-devtools__click` on the language switcher (look for element with class "lang-toggle")
4. Wait for navigation
5. Use `mcp__chrome-devtools__take_snapshot` to verify we're now on `/en` page
6. Verify content changed to English
7. Click language switcher again
8. Verify we're back on `/` with Spanish content

**Expected Results:**

- Language switcher navigates between `/` and `/en`
- Content changes appropriately
- No console errors during navigation

---

### Task 9A.4: Test About Page (Spanish)

**Action:** Test Spanish about page.

**Steps:**

1. Use `mcp__chrome-devtools__navigate_page` to go to `http://localhost:4321/about`
2. Use `mcp__chrome-devtools__take_snapshot`
3. Verify snapshot contains:
   - "Acerca de Mí" (About Me in Spanish)
   - "Ingeniero de Software • Triatleta • Papá"
   - Spanish section headings
4. Use `mcp__chrome-devtools__take_screenshot` and save to `/tmp/about-spanish.png`
5. Check for console errors

**Expected Results:**

- About page loads in Spanish
- All content translated correctly
- No errors

---

### Task 9A.5: Test About Page (English)

**Action:** Test English about page.

**Steps:**

1. Use `mcp__chrome-devtools__navigate_page` to go to `http://localhost:4321/en/about`
2. Use `mcp__chrome-devtools__take_snapshot`
3. Verify snapshot contains:
   - "About Me" (in English)
   - "Software Engineer • Triathlete • Dad"
   - English section headings
4. Use `mcp__chrome-devtools__take_screenshot` and save to `/tmp/about-english.png`
5. Check for console errors

**Expected Results:**

- About page loads in English
- All content translated correctly
- No errors

---

### Task 9A.6: Test Cafe Page Localization

**Action:** Test cafe page in both languages.

**Steps:**

1. Navigate to `http://localhost:4321/cafe` (Spanish)
2. Take snapshot and verify:
   - "Registro de Café" (Coffee Tracker in Spanish)
   - Spanish error/placeholder messages
3. Navigate to `http://localhost:4321/en/cafe` (English)
4. Take snapshot and verify:
   - "Coffee Tracker" (in English)
   - English error/placeholder messages
5. Take screenshots of both versions
6. Check console for errors on both pages

**Expected Results:**

- Cafe page works in both languages
- Error messages properly translated
- No console errors

---

### Task 9A.7: Test Training Page Localization

**Action:** Test training page in both languages.

**Steps:**

1. Navigate to `http://localhost:4321/training` (Spanish)
2. Take snapshot and verify Spanish content
3. Navigate to `http://localhost:4321/en/training` (English)
4. Take snapshot and verify English content
5. Check console for errors

**Expected Results:**

- Training page works in both languages
- Content properly localized

---

### Task 9A.8: Test 404 Page

**Action:** Test 404 page localization.

**Steps:**

1. Navigate to `http://localhost:4321/nonexistent-page`
2. Take snapshot and verify Spanish 404 content:
   - "404 - Página No Encontrada"
   - "Volver al inicio"
3. Navigate to `http://localhost:4321/en/nonexistent-page`
4. Take snapshot and verify English 404 content:
   - "404 - Page Not Found"
   - "Go back home"
5. Take screenshots

**Expected Results:**

- 404 pages work in both languages
- Correct content displayed

---

### Task 9A.9: Test Navigation and Footer in Both Languages

**Action:** Verify navigation and footer are properly translated.

**Steps:**

1. Navigate to Spanish homepage
2. Take snapshot and verify:
   - Nav shows "Inicio"
   - Footer shows Spanish copyright
3. Navigate to English homepage
4. Take snapshot and verify:
   - Nav shows "Home"
   - Footer shows English (or same copyright)
5. Verify footer links work (GitHub, Email, RSS)

**Expected Results:**

- Navigation properly localized
- Footer properly localized
- All footer links functional

---

### Task 9A.10: Test Dark Mode Toggle

**Action:** Verify dark mode works on both language versions.

**Steps:**

1. Navigate to Spanish homepage
2. Take snapshot to find theme toggle button
3. Click theme toggle
4. Take screenshot in dark mode
5. Verify `data-theme="dark"` on `<html>` element
6. Navigate to English homepage
7. Verify dark mode persists (localStorage)
8. Toggle back to light mode

**Expected Results:**

- Dark mode toggle works
- Theme persists across language switches
- No console errors

---

### Task 9A.11: Verify SEO Tags and Meta Data

**Action:** Check SEO tags in both languages.

**Steps:**

1. Navigate to Spanish homepage
2. Use `mcp__chrome-devtools__evaluate_script` to check:
   - `document.documentElement.lang` equals "es"
   - `document.querySelector('link[rel="canonical"]')` exists
   - `document.querySelector('link[hreflang="es"]')` exists
   - `document.querySelector('link[hreflang="en"]')` exists
   - `document.querySelector('meta[property="og:locale"]')` (if exists)
3. Navigate to English homepage
4. Verify same for English:
   - `document.documentElement.lang` equals "en"
   - Canonical and hreflang tags present

**Expected Results:**

- HTML lang attribute correct for each language
- Canonical URLs correct
- Hreflang tags present for both languages
- x-default hreflang points to Spanish (default)

---

### Task 9A.12: Test Blog Posts (If Available)

**Action:** If blog posts exist, test them in both languages.

**Steps:**

1. Navigate to homepage and find a blog post link
2. Click on a Spanish blog post
3. Verify URL format: `/blog/slug-name`
4. Verify content is in Spanish
5. Check if language switcher shows English version (if translation exists)
6. Navigate to English blog post (if exists): `/en/blog/slug-name`
7. Verify content is in English
8. Take screenshots

**Expected Results:**

- Blog posts work in both languages
- URL structure correct
- Language switcher works (if translation exists)

---

### Task 9A.13: Performance Check

**Action:** Run performance trace on homepage.

**Steps:**

1. Navigate to Spanish homepage
2. Use `mcp__chrome-devtools__performance_start_trace` with `reload: true, autoStop: true`
3. Wait for trace to complete
4. Use `mcp__chrome-devtools__performance_stop_trace`
5. Review Core Web Vitals scores (if available)
6. Note any performance insights

**Expected Results:**

- Page loads quickly
- No major performance issues
- Reasonable Core Web Vitals (if measurable in dev)

---

### Task 9A.14: Check Network Requests

**Action:** Verify no failed network requests.

**Steps:**

1. Navigate to Spanish homepage
2. Use `mcp__chrome-devtools__list_network_requests`
3. Check for any failed requests (4xx, 5xx status codes)
4. Verify expected resources loaded:
   - Fonts from Google Fonts
   - Pico CSS from CDN
   - No 404s for images or assets

**Expected Results:**

- All network requests successful
- No 404 or 500 errors
- Expected resources loaded

---

### Task 9A.15: Comprehensive Console Error Check

**Action:** Final check for console errors across all pages.

**Steps:**

1. Navigate to each page in both languages:
   - `/` and `/en` (homepage)
   - `/about` and `/en/about`
   - `/cafe` and `/en/cafe`
   - `/training` and `/en/training`
2. For each page, use `mcp__chrome-devtools__list_console_messages`
3. Look for errors, warnings, or unexpected messages
4. Document any issues found

**Expected Results:**

- No console errors on any page
- No unexpected warnings
- Clean console output

---

### Task 9A.16: Mobile Viewport Testing

**Action:** Test responsive behavior.

**Steps:**

1. Use `mcp__chrome-devtools__resize_page` to set mobile viewport (width: 375, height: 667)
2. Navigate to Spanish homepage
3. Take screenshot of mobile view
4. Verify mobile menu toggle appears
5. Try clicking mobile menu toggle
6. Take screenshot with menu open
7. Resize back to desktop (width: 1920, height: 1080)
8. Verify desktop layout

**Expected Results:**

- Mobile layout renders correctly
- Mobile menu functional
- Desktop layout renders correctly

---

### Task 9A.17: Screenshot Summary

**Action:** Collect all screenshots taken during testing.

**Expected Screenshots:**

- `/tmp/homepage-spanish.png`
- `/tmp/homepage-english.png`
- `/tmp/about-spanish.png`
- `/tmp/about-english.png`
- Additional screenshots from other tests

**Verification:** Review screenshots visually to confirm:

- Content is properly translated
- Layout looks correct
- No visual bugs or issues
- Dark mode works
- Mobile layout works

---

## Phase 9B: Build Verification

### Task 9B.1: Build for Production

**Action:**

```bash
yarn build
```

**Expected:** Build completes successfully with no errors

**Verification:**

- Check build output for any warnings
- Verify `.vercel/output` directory created
- Check bundle sizes are reasonable

---

### Task 9B.2: Preview Production Build

**Action:**

```bash
yarn preview
```

**Expected:** Production build works correctly

**Verification:** Preview server starts on port 4321 (or configured port)

---

### Task 9B.3: Test Production Build with Browser

**Action:** Run subset of browser tests against production build.

**Steps:**

1. Stop dev server if still running
2. Start preview server: `yarn preview`
3. Navigate to `http://localhost:4321/` (or preview URL)
4. Take snapshot and verify Spanish content
5. Navigate to `http://localhost:4321/en`
6. Take snapshot and verify English content
7. Test language switcher
8. Check console for errors

**Expected Results:**

- Production build works identically to dev
- No console errors
- Language switching works
- All functionality intact

---

## Phase 10: Documentation & Cleanup

### Task 10.1: Update CLAUDE.md

**File:** `CLAUDE.md`

**Action:** Update documentation to reflect Spanish as default and new i18n system.

**Key Changes:**

1. Update "Architecture Overview" section
2. Document new translation system with type safety
3. Update examples to show Spanish as default
4. Add documentation for new scripts
5. Update "Common Patterns" section
6. Update i18n section to reflect Spanish as default

---

### Task 10.3: Add Analytics Language Tracking (Optional)

**Action:** If using Google Analytics or other analytics, add language dimension tracking.

**For Google Analytics 4:**

Add to `src/layouts/Layout.astro` in the `<head>` section (if GA is configured):

```astro
<!-- Google Analytics with language tracking -->
<script is:inline define:vars={{ locale }}>
  // Only run if gtag is defined (GA is configured)
  if (typeof gtag !== 'undefined') {
    gtag('set', 'user_properties', {
      language: locale,
    });

    // Track language as custom dimension
    gtag('config', 'GA_MEASUREMENT_ID', {
      custom_map: {
        dimension1: 'language',
      },
    });

    gtag('event', 'language_detected', {
      language: locale,
    });
  }
</script>
```

**For Vercel Analytics:**

Vercel Analytics automatically tracks user language from browser headers, so no additional code needed.

**For Plausible/Simple Analytics:**

Add custom property:

```javascript
if (typeof plausible !== 'undefined') {
  plausible('pageview', { props: { language: locale } });
}
```

**Verification:**

- Add analytics code if desired
- Test that language is tracked correctly
- Verify in analytics dashboard

**Note:** This is optional. Only implement if you actively use analytics and want to track language preference.

---

### Task 10.2: Create Migration Summary

**Action:** Create a summary of all changes made.

**File:** `MIGRATION_SUMMARY.md`

**Content:**

```markdown
# Spanish Default & Enhanced i18n - Migration Summary

## Changes Made

### 1. Default Language Changed

- **Before:** English (no prefix), Spanish (`/es/`)
- **After:** Spanish (no prefix), English (`/en/`)

### 2. New Scripts Added

- `scripts/generate-i18n-types.js` - Generates TypeScript types from translations
- `scripts/validate-translations.js` - Validates translation completeness

### 3. Enhanced Type Safety

- Auto-generated `TranslationKey` type for all translation keys
- IDE autocomplete for translation functions
- Compile-time validation of translation keys

### 4. Consolidated Pages

- **Removed duplicates:** `src/pages/es/index.astro`, `src/pages/es/about.astro`
- **Updated to handle both locales:** `src/pages/index.astro`, `src/pages/about.astro`
- **Created English routes:** `src/pages/en/index.astro`, `src/pages/en/about.astro`

### 5. Translation Files Expanded

- **Before:** ~33 lines each
- **After:** ~150+ lines each
- All hardcoded text extracted to JSON

### 6. Astro i18n Integration

- Added `i18n` config to `astro.config.mjs`
- Better sitemap generation with hreflang
- Standards-compliant routing

### 7. URL Structure

| Page  | Spanish (default) | English         |
| ----- | ----------------- | --------------- |
| Home  | `/`               | `/en`           |
| About | `/about`          | `/en/about`     |
| Blog  | `/blog/slug`      | `/en/blog/slug` |
| Cafe  | `/cafe`           | `/en/cafe`      |

## Testing Performed

- [x] All routes work in both languages
- [x] Language switcher works correctly
- [x] Browser detection redirects appropriately
- [x] RSS feeds work for both languages
- [x] SEO tags (hreflang) correctly configured
- [x] No TypeScript errors
- [x] No linting errors
- [x] Production build successful

## Breaking Changes

- URLs changed: English pages now use `/en/` prefix
- May need redirects if site was publicly accessible with old URLs

## Next Steps

1. Review and test the branch
2. Set up redirects for old English URLs (if needed)
3. Merge to main
4. Deploy to production
5. Monitor for any issues
```

---

## Phase 11: Git Commit & Push

### Task 11.1: Review All Changes

**Action:**

```bash
git status
git diff
```

**Expected:** See all modified files and new scripts

---

### Task 11.2: Commit Changes

**Action:**

```bash
git add .
git commit -m "Switch default language to Spanish and enhance i18n system

- Change default site language from English to Spanish
- English now uses /en/ prefix, Spanish has no prefix
- Add Astro built-in i18n integration for routing
- Implement type-safe translations with auto-generated types
- Add translation validation script to ensure completeness
- Consolidate duplicate language-specific pages into single files
- Extract all hardcoded text to JSON translation files
- Update middleware to redirect based on browser language preference
- Update all pages to use translation function with locale detection
- Add helper function useTranslations() for better DX
- Update RSS feed structure (Spanish at /, English at /en/)

Type safety improvements:
- Auto-generated TranslationKey type from JSON files
- IDE autocomplete for translation keys
- Compile-time validation prevents missing translations

Scripts added:
- generate-i18n-types.js: Creates TypeScript types from translations
- validate-translations.js: Ensures translation completeness in CI

🤖 Generated with Claude Code (https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

### Task 11.3: Push to Remote

**Action:**

```bash
git push -u origin feature/spanish-default-i18n
```

**Expected:** Branch pushed successfully to remote

---

## Phase 12: Final Verification

### Task 12.1: Review Automated Test Results

**Action:** Review all automated browser test results from Phase 9A.

**Verification Checklist:**

**Automated Tests Completed (Phase 9A):**

- [ ] Task 9A.1: Spanish homepage tested with snapshots and screenshots
- [ ] Task 9A.2: English homepage tested with snapshots and screenshots
- [ ] Task 9A.3: Language switcher functionality verified
- [ ] Task 9A.4: Spanish about page tested
- [ ] Task 9A.5: English about page tested
- [ ] Task 9A.6: Cafe page localization verified
- [ ] Task 9A.7: Training page localization verified
- [ ] Task 9A.8: 404 page localization verified
- [ ] Task 9A.9: Navigation and footer translations verified
- [ ] Task 9A.10: Dark mode toggle tested
- [ ] Task 9A.11: SEO tags and metadata verified
- [ ] Task 9A.12: Blog posts tested (if available)
- [ ] Task 9A.13: Performance check completed
- [ ] Task 9A.14: Network requests verified (no 4xx/5xx errors)
- [ ] Task 9A.15: Console errors checked on all pages
- [ ] Task 9A.16: Mobile viewport responsive testing completed
- [ ] Task 9A.17: All screenshots collected and reviewed

**Build Tests Completed (Phase 9B):**

- [ ] Task 9B.1: Production build successful
- [ ] Task 9B.2: Preview server starts correctly
- [ ] Task 9B.3: Production build tested with browser

**Expected State:**

- All screenshots in `/tmp/` directory showing correct content
- No console errors reported
- All pages load in both languages
- Language switcher works bidirectionally
- SEO tags correct (lang, canonical, hreflang)
- Dark mode works
- Mobile layout works

---

### Task 12.2: Optional Manual Verification

**Action:** Optionally perform manual spot-checks if any automated tests raised concerns.

**Quick Manual Checks (if needed):**

- [ ] Visit `/` in browser - verify Spanish content looks good
- [ ] Visit `/en` - verify English content looks good
- [ ] Test language switcher manually - verify smooth transition
- [ ] Check dark mode toggle - verify it works smoothly
- [ ] Test on mobile viewport - verify responsive design

**Note:** Most testing was done automatically in Phase 9A. Only perform manual checks if automated tests indicated issues.

---

## Success Criteria

✅ **All tasks completed when:**

1. **Branch Management:**
   - Branch `feature/spanish-default-i18n` exists and is pushed to remote ✅

2. **Build & Validation Scripts:**
   - `yarn generate:i18n` runs without errors ✅
   - `yarn validate:i18n` runs without errors ✅
   - `yarn check` passes (type check + lint + format) ✅
   - `yarn build` completes successfully ✅

3. **Automated Browser Tests (Phase 9A - 17 tasks):**
   - Spanish homepage loads with correct content ✅
   - English homepage loads with correct content ✅
   - Language switcher works bidirectionally ✅
   - About, Cafe, Training pages work in both languages ✅
   - 404 page localized correctly ✅
   - Navigation and footer properly translated ✅
   - Dark mode toggle works ✅
   - SEO tags verified (lang, canonical, hreflang) ✅
   - No console errors on any page ✅
   - Network requests all successful (no 404s) ✅
   - Performance check completed ✅
   - Mobile viewport responsive ✅
   - Screenshots captured and reviewed ✅

4. **Production Build Testing (Phase 9B):**
   - Production build successful ✅
   - Preview server works correctly ✅
   - Production build tested with browser ✅

5. **Implementation Requirements:**
   - Spanish is the default language (no prefix: `/`) ✅
   - English uses `/en/` prefix ✅
   - All hardcoded text extracted to JSON ✅
   - Type safety implemented with autocomplete ✅
   - Pre-commit hooks validate translations ✅

6. **Documentation:**
   - CLAUDE.md updated with new i18n system ✅
   - MIGRATION_SUMMARY.md created ✅

7. **Git:**
   - Clean commit with descriptive message ✅
   - Follows git commit guidelines (no Claude/Anthropic as co-author in main message) ✅

---

## Notes for Claude Code

This plan is designed to be executed autonomously. Follow each task in order, verifying success before moving to the next task. If any task fails:

1. Read the error message carefully
2. Check the "Verification" step for that task
3. Review related files
4. Fix the issue
5. Continue from that task

Key principles:

- **Don't skip verification steps** - they catch issues early
- **Use Chrome DevTools MCP for testing** - Phase 9A has 17 automated browser tests
- **Test frequently** - run `yarn dev` after major changes
- **Use TypeScript** - it will catch many errors
- **Follow the pattern** - once you update one page, apply the same pattern to others
- **Keep git commits atomic** - one logical change per commit (or all changes in one commit at the end)
- **Save screenshots** - Use `/tmp/` directory for test screenshots for visual verification

## Automated Testing Approach

Phase 9A uses Chrome DevTools MCP extensively for automated browser testing:

- **Navigate pages**: Use `mcp__chrome-devtools__navigate_page`
- **Capture content**: Use `mcp__chrome-devtools__take_snapshot`
- **Visual verification**: Use `mcp__chrome-devtools__take_screenshot`
- **Check errors**: Use `mcp__chrome-devtools__list_console_messages`
- **Verify functionality**: Use `mcp__chrome-devtools__click`, `evaluate_script`, etc.
- **Test responsive**: Use `mcp__chrome-devtools__resize_page`

This automated approach ensures comprehensive testing without manual intervention.

## Pre-commit Hooks

The updated `lint-staged` configuration ensures:

- Translation JSON files are validated on every commit
- TypeScript types are regenerated automatically
- No commits with mismatched translations
- Generated types file is automatically staged

## Expected Outcome

The end result should be a fully functional bilingual site with:

- Spanish as the default language (no URL prefix)
- English with `/en/` prefix
- Type-safe translations with IDE autocomplete
- Comprehensive automated browser test coverage
- Pre-commit validation preventing translation errors
- Clean, maintainable codebase
